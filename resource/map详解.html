<!DOCTYPE html>
<!-- saved from url=(0053)https://www.ququ123.top/2022/04/golang_map_principle/ -->
<html lang="en-us" data-scheme="light"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="åŸæ–‡é“¾æ¥ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ è¿™ç¯‡æ–‡ç« ä¸»è¦è®² map çš„èµ‹å€¼ã€åˆ é™¤ã€æŸ¥è¯¢ã€æ‰©å®¹çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œä»ç„¶æ˜¯ä»åº•å±‚çš„è§’åº¦å±•å¼€ã€‚ç»“åˆæºç ï¼Œçœ‹å®Œæœ¬æ–‡ä¸€å®šä¼šå½»åº•æ˜ç™½ map åº•"><title>ã€golangã€‘map è¯¦è§£</title>

<link rel="canonical" href="http://www.ququ123.top/2022/04/golang_map_principle/">

<link rel="stylesheet" href="./ã€golangã€‘map è¯¦è§£_files/style.min.46208cabd58e8bcef0cfb7d7ea6b561adcca3b91dd1fc6657493a44f03c5db75.css"><script src="./ã€golangã€‘map è¯¦è§£_files/pangu.min.js"></script><script src="./ã€golangã€‘map è¯¦è§£_files/hm.js"></script><script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script><meta property="og:title" content="ã€golangã€‘mapè¯¦è§£">
<meta property="og:description" content="åŸæ–‡é“¾æ¥ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ è¿™ç¯‡æ–‡ç« ä¸»è¦è®² map çš„èµ‹å€¼ã€åˆ é™¤ã€æŸ¥è¯¢ã€æ‰©å®¹çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œä»ç„¶æ˜¯ä»åº•å±‚çš„è§’åº¦å±•å¼€ã€‚ç»“åˆæºç ï¼Œçœ‹å®Œæœ¬æ–‡ä¸€å®šä¼šå½»åº•æ˜ç™½ map åº•">
<meta property="og:url" content="http://www.ququ123.top/2022/04/golang_map_principle/">
<meta property="og:site_name" content="ä»£ç ä¸å†å²">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-04-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-01T00:00:00+00:00"><meta property="og:image" content="https://img.ququ123.top/img/u=1862939405,1689361694&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG">
<meta name="twitter:title" content="ã€golangã€‘mapè¯¦è§£">
<meta name="twitter:description" content="åŸæ–‡é“¾æ¥ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ è¿™ç¯‡æ–‡ç« ä¸»è¦è®² map çš„èµ‹å€¼ã€åˆ é™¤ã€æŸ¥è¯¢ã€æ‰©å®¹çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œä»ç„¶æ˜¯ä»åº•å±‚çš„è§’åº¦å±•å¼€ã€‚ç»“åˆæºç ï¼Œçœ‹å®Œæœ¬æ–‡ä¸€å®šä¼šå½»åº•æ˜ç™½ map åº•"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://img.ququ123.top/img/u=1862939405,1689361694&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG">

<link rel="shortcut icon" href="https://www.ququ123.top/2022/04/golang_map_principle/favicon.ico">


    <link rel="shortcut icon" href="https://www.ququ123.top/2022/04/golang_map_principle/img/avatar.png">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?315f9dbf10ef402a385430f08eb1c383";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script async="" src="./ã€golangã€‘map è¯¦è§£_files/busuanzi.pure.mini.js"></script>
<script defer="" src="./ã€golangã€‘map è¯¦è§£_files/script.js" data-website-id="d501d708-5722-4653-be01-e0919e4163fd"></script><script src="./ã€golangã€‘map è¯¦è§£_files/autoload.js"></script><link rel="stylesheet" href="./ã€golangã€‘map è¯¦è§£_files/waifu.css"><script src="./ã€golangã€‘map è¯¦è§£_files/live2d.min.js"></script><script src="./ã€golangã€‘map è¯¦è§£_files/waifu-tips.js"></script>

    <link href="./ã€golangã€‘map è¯¦è§£_files/css2" type="text/css" rel="stylesheet"><style id="waline-darkmode"></style></head>
    <body class="
    article-page
" style="transition: background-color 0.3s ease 0s;">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    &lt;!-- 
        extended
     --&gt;
    on-phone--column extended
">
    
<div id="article-toolbar">
    <a href="http://www.ququ123.top/" class="back-home">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <polyline points="15 6 9 12 15 18"></polyline>
</svg>



        <span>è¿”å›</span>
    </a>
</div>
    <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            
            <figure class="site-avatar">
                <a href="https://www.ququ123.top/">
                
                    
                    
                    
                        
                        <img src="./ã€golangã€‘map è¯¦è§£_files/avatar_hu2f3b8fee1771f62c9935407d819741ec_30389_300x0_resize_box_3.png" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <h1 class="site-name"><a href="https://www.ququ123.top/">ä»£ç ä¸å†å²</a></h1>
        <h2 class="site-description">No code, no talk.</h2><ol class="social-menu">
                
                    <li>
                        <a href="https://github.com/zhulingbiezhi" target="_blank" title="GitHub">
                            
                            
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>



                            
                        </a>
                    </li>
                
            </ol></header>

    <ol class="menu" id="main-menu">
        
        
        

        <li>
            <a href="https://www.ququ123.top/">
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <polyline points="5 12 3 12 12 3 21 12 19 12"></polyline>
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li>
            <a href="https://www.ququ123.top/links/">
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <polyline points="5 12 3 12 12 3 21 12 19 12"></polyline>
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        

        <li>
            <a href="https://www.ququ123.top/%E5%85%B3%E4%BA%8E/">
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="12" cy="7" r="4"></circle>
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg>



                
                <span> å…³äº</span>
            </a>
        </li>
        
        

        <li>
            <a href="https://www.ququ123.top/archives/">
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <rect x="3" y="4" width="18" height="4" rx="2"></rect>
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10"></path>
  <line x1="10" y1="12" x2="14" y2="12"></line>
</svg>



                
                <span> Archives</span>
            </a>
        </li>
        
        

        <li>
            <a href="https://www.ququ123.top/search/">
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="10" cy="10" r="7"></circle>
  <line x1="21" y1="21" x2="15" y2="15"></line>
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        
            <li id="dark-mode-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="8" cy="12" r="2"></circle>
  <rect x="2" y="6" width="20" height="12" rx="6"></rect>
</svg>



                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="16" cy="12" r="2"></circle>
  <rect x="2" y="6" width="20" height="12" rx="6"></rect>
</svg>



                <span> æš—è‰²æ¨¡å¼</span>
            </li>
        
    </ol>
</aside>

<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="https://www.ququ123.top/2022/04/golang_map_principle/">
                
                    <img src="./ã€golangã€‘map è¯¦è§£_files/u=1862939405,1689361694&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG" loading="lazy" alt="Featured image of post ã€golangã€‘mapè¯¦è§£">
                
            </a>
        </div>  
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="https://www.ququ123.top/categories/golang/" style="background-color: #2a9d8f; color: #fff;">
                golang
            </a>
        
    </header>
    

    <h2 class="article-title">
        <a href="https://www.ququ123.top/2022/04/golang_map_principle/">ã€golangã€‘map è¯¦è§£</a>
    </h2>

    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4"></path>
  <circle cx="18" cy="18" r="4"></circle>
  <path d="M15 3v4"></path>
  <path d="M7 3v4"></path>
  <path d="M3 11h16"></path>
  <path d="M18 16.496v1.504l1 1"></path>
</svg>
                <time class="article-time--published"> 2022 å¹´ 04 æœˆ 01 æ—¥</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="12" cy="12" r="9"></circle>
  <polyline points="12 7 12 12 15 15"></polyline>
</svg>



                <time class="article-words">
                    19696 å­—
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
<a href="https://www.digitalocean.com/?refcode=6c62bac11425&amp;utm_campaign=Referral_Invite&amp;utm_medium=Referral_Program&amp;utm_source=badge"><img src="./ã€golangã€‘map è¯¦è§£_files/Badge 1.svg" alt="DigitalOcean Referral Badge"></a>
<a href="https://www.digitalocean.com/?refcode=6c62bac11425&amp;utm_campaign=Referral_Invite&amp;utm_medium=Referral_Program&amp;utm_source=badge"><img src="./ã€golangã€‘map è¯¦è§£_files/Badge 3.svg" alt="DigitalOcean Referral Badge"></a>
<a href="https://www.digitalocean.com/?refcode=6c62bac11425&amp;utm_campaign=Referral_Invite&amp;utm_medium=Referral_Program&amp;utm_source=badge"><img src="./ã€golangã€‘map è¯¦è§£_files/Badge 2.svg" alt="DigitalOcean Referral Badge"></a> 

    
    
    <p><a class="link" href="https://www.ququ123.top/2024/03/ququ-blog" target="_blank" rel="noopener">åŸæ–‡é“¾æ¥ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„</a></p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®² map çš„èµ‹å€¼ã€åˆ é™¤ã€æŸ¥è¯¢ã€æ‰©å®¹çš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹ï¼Œä»ç„¶æ˜¯ä»åº•å±‚çš„è§’åº¦å±•å¼€ã€‚ç»“åˆæºç ï¼Œçœ‹å®Œæœ¬æ–‡ä¸€å®šä¼šå½»åº•æ˜ç™½ map åº•å±‚åŸç†ã€‚</p>
<p>æˆ‘è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œå¯¹ map çš„åŸºæœ¬ç”¨æ³•æ¶‰åŠæ¯”è¾ƒå°‘ï¼Œæˆ‘ç›¸ä¿¡å¯ä»¥é€šè¿‡é˜…è¯»å…¶ä»–å…¥é—¨ä¹¦ç±äº†è§£ã€‚æœ¬æ–‡çš„å†…å®¹æ¯”è¾ƒæ·±å…¥ï¼Œä½†æ˜¯ç”±äºæˆ‘ç”»äº†å„ç§å›¾ï¼Œæˆ‘ç›¸ä¿¡å¾ˆå®¹æ˜“çœ‹æ‡‚ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯-map">ä»€ä¹ˆæ˜¯ map</h2>
<p>ç»´åŸºç™¾ç§‘é‡Œè¿™æ ·å®šä¹‰ mapï¼š</p>
<blockquote>
<p>In computer science, an associative array, map, symbol table, or dictionary is an abstract data type composed of a collection of (key, value) pairs, such that each possible key appears at most once in the collection.</p>
</blockquote>
<p>ç®€å•è¯´æ˜ä¸€ä¸‹ï¼šåœ¨è®¡ç®—æœºç§‘å­¦é‡Œï¼Œè¢«ç§°ä¸ºç›¸å…³æ•°ç»„ã€mapã€ç¬¦å·è¡¨æˆ–è€…å­—å…¸ï¼Œæ˜¯ç”±ä¸€ç»„ <code>&lt;key, value&gt;</code> å¯¹ç»„æˆçš„æŠ½è±¡æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”åŒä¸€ä¸ª key åªä¼šå‡ºç°ä¸€æ¬¡ã€‚</p>
<p>æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼šmap æ˜¯ç”± <code>key-value</code> å¯¹ç»„æˆçš„ï¼›<code>key</code> åªä¼šå‡ºç°ä¸€æ¬¡ã€‚</p>
<p>å’Œ map ç›¸å…³çš„æ“ä½œä¸»è¦æ˜¯ï¼š</p>
<ol>
<li>å¢åŠ ä¸€ä¸ª k-v å¯¹ â€”â€” Add or insertï¼›</li>
<li>åˆ é™¤ä¸€ä¸ª k-v å¯¹ â€”â€” Remove or deleteï¼›</li>
<li>ä¿®æ”¹æŸä¸ª k å¯¹åº”çš„ v â€”â€” Reassignï¼›</li>
<li>æŸ¥è¯¢æŸä¸ª k å¯¹åº”çš„ v â€”â€” Lookupï¼›</li>
</ol>
<p>ç®€å•è¯´å°±æ˜¯æœ€åŸºæœ¬çš„ <code>å¢åˆ æŸ¥æ”¹</code>ã€‚</p>
<p>map çš„è®¾è®¡ä¹Ÿè¢«ç§°ä¸º â€œThe dictionary problemâ€ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯è®¾è®¡ä¸€ç§æ•°æ®ç»“æ„ç”¨æ¥ç»´æŠ¤ä¸€ä¸ªé›†åˆçš„æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å¯¹é›†åˆè¿›è¡Œå¢åˆ æŸ¥æ”¹çš„æ“ä½œã€‚æœ€ä¸»è¦çš„æ•°æ®ç»“æ„æœ‰ä¸¤ç§ï¼š<code>å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼ˆHash tableï¼‰</code>ã€<code>æœç´¢æ ‘ï¼ˆSearch treeï¼‰</code>ã€‚</p>
<p>å“ˆå¸ŒæŸ¥æ‰¾è¡¨ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°å°† key åˆ†é…åˆ°ä¸åŒçš„æ¡¶ï¼ˆbucketï¼Œä¹Ÿå°±æ˜¯æ•°ç»„çš„ä¸åŒ indexï¼‰ã€‚è¿™æ ·ï¼Œå¼€é”€ä¸»è¦åœ¨å“ˆå¸Œå‡½æ•°çš„è®¡ç®—ä»¥åŠæ•°ç»„çš„å¸¸æ•°è®¿é—®æ—¶é—´ã€‚åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œå“ˆå¸ŒæŸ¥æ‰¾è¡¨çš„æ€§èƒ½å¾ˆé«˜ã€‚</p>
<p>å“ˆå¸ŒæŸ¥æ‰¾è¡¨ä¸€èˆ¬ä¼šå­˜åœ¨ â€œç¢°æ’â€ çš„é—®é¢˜ï¼Œå°±æ˜¯è¯´ä¸åŒçš„ key è¢«å“ˆå¸Œåˆ°äº†åŒä¸€ä¸ª bucketã€‚ä¸€èˆ¬æœ‰ä¸¤ç§åº”å¯¹æ–¹æ³•ï¼š<code>é“¾è¡¨æ³•</code>å’Œ<code>å¼€æ”¾åœ°å€æ³•</code>ã€‚<code>é“¾è¡¨æ³•</code>å°†ä¸€ä¸ª bucket å®ç°æˆä¸€ä¸ªé“¾è¡¨ï¼Œè½åœ¨åŒä¸€ä¸ª bucket ä¸­çš„ key éƒ½ä¼šæ’å…¥è¿™ä¸ªé“¾è¡¨ã€‚<code>å¼€æ”¾åœ°å€æ³•</code>åˆ™æ˜¯ç¢°æ’å‘ç”Ÿåï¼Œé€šè¿‡ä¸€å®šçš„è§„å¾‹ï¼Œåœ¨æ•°ç»„çš„åé¢æŒ‘é€‰ â€œç©ºä½â€ï¼Œç”¨æ¥æ”¾ç½®æ–°çš„ keyã€‚</p>
<p>æœç´¢æ ‘æ³•ä¸€èˆ¬é‡‡ç”¨è‡ªå¹³è¡¡æœç´¢æ ‘ï¼ŒåŒ…æ‹¬ï¼šAVL æ ‘ï¼Œçº¢é»‘æ ‘ã€‚é¢è¯•æ—¶ç»å¸¸ä¼šè¢«é—®åˆ°ï¼Œç”šè‡³è¢«è¦æ±‚æ‰‹å†™çº¢é»‘æ ‘ä»£ç ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œé¢è¯•å®˜è‡ªå·±éƒ½å†™ä¸ä¸Šæ¥ï¼Œéå¸¸è¿‡åˆ†ã€‚</p>
<p>è‡ªå¹³è¡¡æœç´¢æ ‘æ³•çš„æœ€å·®æœç´¢æ•ˆç‡æ˜¯ O(logN)ï¼Œè€Œå“ˆå¸ŒæŸ¥æ‰¾è¡¨æœ€å·®æ˜¯ O(N)ã€‚å½“ç„¶ï¼Œå“ˆå¸ŒæŸ¥æ‰¾è¡¨çš„å¹³å‡æŸ¥æ‰¾æ•ˆç‡æ˜¯ O(1)ï¼Œå¦‚æœå“ˆå¸Œå‡½æ•°è®¾è®¡çš„å¾ˆå¥½ï¼Œæœ€åçš„æƒ…å†µåŸºæœ¬ä¸ä¼šå‡ºç°ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œéå†è‡ªå¹³è¡¡æœç´¢æ ‘ï¼Œè¿”å›çš„ key åºåˆ—ï¼Œä¸€èˆ¬ä¼šæŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºï¼›è€Œå“ˆå¸ŒæŸ¥æ‰¾è¡¨åˆ™æ˜¯ä¹±åºçš„ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨-map">ä¸ºä»€ä¹ˆè¦ç”¨ map</h2>
<p>ä» Go è¯­è¨€å®˜æ–¹åšå®¢æ‘˜å½•ä¸€æ®µè¯ï¼š</p>
<blockquote>
<p>One of the most useful data structures in computer science is the hash table. Many hash table implementations exist with varying properties, but in general they offer fast lookups, adds, and deletes. Go provides a built-in map type that implements a hash table.</p>
</blockquote>
<p>hash table æ˜¯è®¡ç®—æœºæ•°æ®ç»“æ„ä¸­ä¸€ä¸ªæœ€é‡è¦çš„è®¾è®¡ã€‚å¤§éƒ¨åˆ† hash table éƒ½å®ç°äº†å¿«é€ŸæŸ¥æ‰¾ã€æ·»åŠ ã€åˆ é™¤çš„åŠŸèƒ½ã€‚Go è¯­è¨€å†…ç½®çš„ map å®ç°äº†ä¸Šè¿°æ‰€æœ‰åŠŸèƒ½ã€‚</p>
<p>å¾ˆéš¾æƒ³è±¡å†™ä¸€ä¸ªç¨‹åºä¸ä½¿ç”¨ mapï¼Œä»¥è‡³äºåœ¨å›ç­”ä¸ºä»€ä¹ˆè¦ç”¨ map è¿™ä¸ªé—®é¢˜ä¸ŠçŠ¯äº†éš¾ã€‚</p>
<p>æ‰€ä»¥ï¼Œåˆ°åº•ä¸ºä»€ä¹ˆè¦ç”¨ map å‘¢ï¼Ÿå› ä¸ºå®ƒå¤ªå¼ºå¤§äº†ï¼Œå„ç§å¢åˆ æŸ¥æ”¹çš„æ“ä½œæ•ˆç‡éå¸¸é«˜ã€‚</p>
<h2 id="map-çš„åº•å±‚å¦‚ä½•å®ç°">map çš„åº•å±‚å¦‚ä½•å®ç°</h2>
<p>é¦–å…ˆå£°æ˜æˆ‘ç”¨çš„ Go ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-go">    go version go1.9.2 darwin/amd64
</code></pre>
<p>å‰é¢è¯´äº† map å®ç°çš„å‡ ç§æ–¹æ¡ˆï¼ŒGo è¯­è¨€é‡‡ç”¨çš„æ˜¯å“ˆå¸ŒæŸ¥æ‰¾è¡¨ï¼Œå¹¶ä¸”ä½¿ç”¨é“¾è¡¨è§£å†³å“ˆå¸Œå†²çªã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ¢ç´¢ map çš„æ ¸å¿ƒåŸç†ï¼Œä¸€çª¥å®ƒçš„å†…éƒ¨ç»“æ„ã€‚</p>
<h2 id="map-å†…å­˜æ¨¡å‹">map å†…å­˜æ¨¡å‹</h2>
<p>åœ¨æºç ä¸­ï¼Œè¡¨ç¤º map çš„ç»“æ„ä½“æ˜¯ hmapï¼Œå®ƒæ˜¯ hashmap çš„ â€œç¼©å†™â€ï¼š</p>
<pre><code class="language-go">    // A header for a Go map.
    type hmap struct {
        // å…ƒç´ ä¸ªæ•°ï¼Œè°ƒç”¨ len(map) æ—¶ï¼Œç›´æ¥è¿”å›æ­¤å€¼
    	count     int
    	flags     uint8
    	// buckets çš„å¯¹æ•° log_2
    	B         uint8
    	// overflow çš„ bucket è¿‘ä¼¼æ•°
    	noverflow uint16
    	// è®¡ç®— key çš„å“ˆå¸Œçš„æ—¶å€™ä¼šä¼ å…¥å“ˆå¸Œå‡½æ•°
    	hash0     uint32
        // æŒ‡å‘ buckets æ•°ç»„ï¼Œå¤§å°ä¸º 2^B
        // å¦‚æœå…ƒç´ ä¸ªæ•°ä¸º0ï¼Œå°±ä¸º nil
    	buckets    unsafe.Pointer
    	// æ‰©å®¹çš„æ—¶å€™ï¼Œbuckets é•¿åº¦ä¼šæ˜¯ oldbuckets çš„ä¸¤å€
    	oldbuckets unsafe.Pointer
    	// æŒ‡ç¤ºæ‰©å®¹è¿›åº¦ï¼Œå°äºæ­¤åœ°å€çš„ buckets è¿ç§»å®Œæˆ
    	nevacuate  uintptr
    	extra *mapextra // optional fields
    }
</code></pre>
<p>è¯´æ˜ä¸€ä¸‹ï¼Œ<code>B</code> æ˜¯ buckets æ•°ç»„çš„é•¿åº¦çš„å¯¹æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ buckets æ•°ç»„çš„é•¿åº¦å°±æ˜¯ 2^Bã€‚bucket é‡Œé¢å­˜å‚¨äº† key å’Œ valueï¼Œåé¢ä¼šå†è®²ã€‚</p>
<p>buckets æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæœ€ç»ˆå®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š</p>
<pre><code class="language-go">    type bmap struct {
    	tophash [bucketCnt]uint8
    }
</code></pre>
<p>ä½†è¿™åªæ˜¯è¡¨é¢ (src/runtime/hashmap.go) çš„ç»“æ„ï¼Œç¼–è¯‘æœŸé—´ä¼šç»™å®ƒåŠ æ–™ï¼ŒåŠ¨æ€åœ°åˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ï¼š</p>
<pre><code class="language-go">    type bmap struct {
        topbits  [8]uint8
        keys     [8]keytype
        values   [8]valuetype
        pad      uintptr
        overflow uintptr
    }
</code></pre>
<p><code>bmap</code> å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ â€œæ¡¶â€ï¼Œæ¡¶é‡Œé¢ä¼šæœ€å¤šè£… 8 ä¸ª keyï¼Œè¿™äº› key ä¹‹æ‰€ä»¥ä¼šè½å…¥åŒä¸€ä¸ªæ¡¶ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ç»è¿‡å“ˆå¸Œè®¡ç®—åï¼Œå“ˆå¸Œç»“æœæ˜¯â€œä¸€ç±»â€ çš„ã€‚åœ¨æ¡¶å†…ï¼Œåˆä¼šæ ¹æ® key è®¡ç®—å‡ºæ¥çš„ hash å€¼çš„é«˜ 8 ä½æ¥å†³å®š key åˆ°åº•è½å…¥æ¡¶å†…çš„å“ªä¸ªä½ç½®ï¼ˆä¸€ä¸ªæ¡¶å†…æœ€å¤šæœ‰ 8 ä¸ªä½ç½®ï¼‰ã€‚</p>
<p>æ¥ä¸€ä¸ªæ•´ä½“çš„å›¾ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57576986-acd87600-749f-11e9-8710-75e423c7efdb.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57576986-acd87600-749f-11e9-8710-75e423c7efdb.png" loading="lazy" alt="hashmap bmap">
	</a>
	
	<figcaption>hashmap bmap</figcaption>
	
</figure><p></p>
<p>å½“ map çš„ key å’Œ value éƒ½ä¸æ˜¯æŒ‡é’ˆï¼Œå¹¶ä¸” size éƒ½å°äº 128 å­—èŠ‚çš„æƒ…å†µä¸‹ï¼Œä¼šæŠŠ bmap æ ‡è®°ä¸ºä¸å«æŒ‡é’ˆï¼Œè¿™æ ·å¯ä»¥é¿å… gc æ—¶æ‰«ææ•´ä¸ª hmapã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çœ‹ bmap å…¶å®æœ‰ä¸€ä¸ª overflow çš„å­—æ®µï¼Œæ˜¯æŒ‡é’ˆç±»å‹çš„ï¼Œç ´åäº† bmap ä¸å«æŒ‡é’ˆçš„è®¾æƒ³ï¼Œè¿™æ—¶ä¼šæŠŠ overflow ç§»åŠ¨åˆ° extra å­—æ®µæ¥ã€‚</p>
<pre><code class="language-go">    type mapextra struct {
    	// overflow[0] contains overflow buckets for hmap.buckets.
    	// overflow[1] contains overflow buckets for hmap.oldbuckets.
    	overflow [2]*[]*bmap
    
    	// nextOverflow åŒ…å«ç©ºé—²çš„ overflow bucketï¼Œè¿™æ˜¯é¢„åˆ†é…çš„ bucket
    	nextOverflow *bmap
    }
</code></pre>
<p>bmap æ˜¯å­˜æ”¾ k-v çš„åœ°æ–¹ï¼Œæˆ‘ä»¬æŠŠè§†è§’æ‹‰è¿‘ï¼Œä»”ç»†çœ‹ bmap çš„å†…éƒ¨ç»„æˆã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57577391-f88f1d80-74a7-11e9-893c-4783dc4fb35e.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57577391-f88f1d80-74a7-11e9-893c-4783dc4fb35e.png" loading="lazy" alt="bmap struct">
	</a>
	
	<figcaption>bmap struct</figcaption>
	
</figure><p></p>
<p>ä¸Šå›¾å°±æ˜¯ bucket çš„å†…å­˜æ¨¡å‹ï¼Œ<code>HOB Hash</code> æŒ‡çš„å°±æ˜¯ top hashã€‚ æ³¨æ„åˆ° key å’Œ value æ˜¯å„è‡ªæ”¾åœ¨ä¸€èµ·çš„ï¼Œå¹¶ä¸æ˜¯ <code>key/value/key/value/...</code> è¿™æ ·çš„å½¢å¼ã€‚æºç é‡Œè¯´æ˜è¿™æ ·çš„å¥½å¤„æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥çœç•¥æ‰ padding å­—æ®µï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªç±»å‹çš„ mapï¼š</p>
<pre><code class="language-go">    map[int64]int8
</code></pre>
<p>å¦‚æœæŒ‰ç…§ <code>key/value/key/value/...</code> è¿™æ ·çš„æ¨¡å¼å­˜å‚¨ï¼Œé‚£åœ¨æ¯ä¸€ä¸ª key/value å¯¹ä¹‹åéƒ½è¦é¢å¤– padding 7 ä¸ªå­—èŠ‚ï¼›è€Œå°†æ‰€æœ‰çš„ keyï¼Œvalue åˆ†åˆ«ç»‘å®šåˆ°ä¸€èµ·ï¼Œè¿™ç§å½¢å¼ <code>key/key/.../value/value/...</code>ï¼Œåˆ™åªéœ€è¦åœ¨æœ€åæ·»åŠ  paddingã€‚</p>
<p>æ¯ä¸ª bucket è®¾è®¡æˆæœ€å¤šåªèƒ½æ”¾ 8 ä¸ª key-value å¯¹ï¼Œå¦‚æœæœ‰ç¬¬ 9 ä¸ª key-value è½å…¥å½“å‰çš„ bucketï¼Œé‚£å°±éœ€è¦å†æ„å»ºä¸€ä¸ª bucket ï¼Œé€šè¿‡ <code>overflow</code> æŒ‡é’ˆè¿æ¥èµ·æ¥ã€‚</p>
<h2 id="åˆ›å»º-map">åˆ›å»º map</h2>
<p>ä»è¯­æ³•å±‚é¢ä¸Šæ¥è¯´ï¼Œåˆ›å»º map å¾ˆç®€å•ï¼š</p>
<pre><code class="language-go">    ageMp := make(map[string]int)
    // æŒ‡å®š map é•¿åº¦
    ageMp := make(map[string]int, 8)
    
    // ageMp ä¸º nilï¼Œä¸èƒ½å‘å…¶æ·»åŠ å…ƒç´ ï¼Œä¼šç›´æ¥panic
    var ageMp map[string]int
</code></pre>
<p>é€šè¿‡æ±‡ç¼–è¯­è¨€å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šåº•å±‚è°ƒç”¨çš„æ˜¯ <code>makemap</code> å‡½æ•°ï¼Œä¸»è¦åšçš„å·¥ä½œå°±æ˜¯åˆå§‹åŒ– <code>hmap</code> ç»“æ„ä½“çš„å„ç§å­—æ®µï¼Œä¾‹å¦‚è®¡ç®— B çš„å¤§å°ï¼Œè®¾ç½®å“ˆå¸Œç§å­ hash0 ç­‰ç­‰ã€‚</p>
<pre><code class="language-go">    func makemap(t *maptype, hint int64, h *hmap, bucket unsafe.Pointer) *hmap {
    	// çœç•¥å„ç§æ¡ä»¶æ£€æŸ¥...
    
    	// æ‰¾åˆ°ä¸€ä¸ª Bï¼Œä½¿å¾— map çš„è£…è½½å› å­åœ¨æ­£å¸¸èŒƒå›´å†…
    	B := uint8(0)
    	for ; overLoadFactor(hint, B); B++ {
    	}
    
    	// åˆå§‹åŒ– hash table
    	// å¦‚æœ B ç­‰äº 0ï¼Œé‚£ä¹ˆ buckets å°±ä¼šåœ¨èµ‹å€¼çš„æ—¶å€™å†åˆ†é…
    	// å¦‚æœé•¿åº¦æ¯”è¾ƒå¤§ï¼Œåˆ†é…å†…å­˜ä¼šèŠ±è´¹é•¿ä¸€ç‚¹
    	buckets := bucket
    	var extra *mapextra
    	if B != 0 {
    		var nextOverflow *bmap
    		buckets, nextOverflow = makeBucketArray(t, B)
    		if nextOverflow != nil {
    			extra = new(mapextra)
    			extra.nextOverflow = nextOverflow
    		}
    	}
    
    	// åˆå§‹åŒ– hamp
    	if h == nil {
    		h = (*hmap)(newobject(t.hmap))
    	}
    	h.count = 0
    	h.B = B
    	h.extra = extra
    	h.flags = 0
    	h.hash0 = fastrand()
    	h.buckets = buckets
    	h.oldbuckets = nil
    	h.nevacuate = 0
    	h.noverflow = 0
    
    	return h
    }
</code></pre>
<p>æ³¨æ„ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„ç»“æœï¼š<code>*hmap</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œæˆ‘ä»¬ä¹‹å‰è®²è¿‡çš„ <code>makeslice</code> å‡½æ•°è¿”å›çš„æ˜¯ <code>Slice</code> ç»“æ„ä½“ï¼š</p>
<pre><code class="language-go">    func makeslice(et *_type, len, cap int) slice
</code></pre>
<p>å›é¡¾ä¸€ä¸‹ slice çš„ç»“æ„ä½“å®šä¹‰ï¼š</p>
<pre><code class="language-go">    // runtime/slice.go
    type slice struct {
        array unsafe.Pointer // å…ƒç´ æŒ‡é’ˆ
        len   int // é•¿åº¦ 
        cap   int // å®¹é‡
    }
</code></pre>
<p>ç»“æ„ä½“å†…éƒ¨åŒ…å«åº•å±‚çš„æ•°æ®æŒ‡é’ˆã€‚</p>
<p>makemap å’Œ makeslice çš„åŒºåˆ«ï¼Œå¸¦æ¥ä¸€ä¸ªä¸åŒç‚¹ï¼šå½“ map å’Œ slice ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œåœ¨å‡½æ•°å‚æ•°å†…éƒ¨å¯¹ map çš„æ“ä½œä¼šå½±å“ map è‡ªèº«ï¼›è€Œå¯¹ slice å´ä¸ä¼šï¼ˆä¹‹å‰è®² slice çš„æ–‡ç« é‡Œæœ‰è®²è¿‡ï¼‰ã€‚</p>
<p>ä¸»è¦åŸå› ï¼šä¸€ä¸ªæ˜¯æŒ‡é’ˆï¼ˆ<code>*hmap</code>ï¼‰ï¼Œä¸€ä¸ªæ˜¯ç»“æ„ä½“ï¼ˆ<code>slice</code>ï¼‰ã€‚Go è¯­è¨€ä¸­çš„å‡½æ•°ä¼ å‚éƒ½æ˜¯å€¼ä¼ é€’ï¼Œåœ¨å‡½æ•°å†…éƒ¨ï¼Œå‚æ•°ä¼šè¢« copy åˆ°æœ¬åœ°ã€‚<code>*hmap</code>æŒ‡é’ˆ copy å®Œä¹‹åï¼Œä»ç„¶æŒ‡å‘åŒä¸€ä¸ª mapï¼Œå› æ­¤å‡½æ•°å†…éƒ¨å¯¹ map çš„æ“ä½œä¼šå½±å“å®å‚ã€‚è€Œ slice è¢« copy åï¼Œä¼šæˆä¸ºä¸€ä¸ªæ–°çš„ sliceï¼Œå¯¹å®ƒè¿›è¡Œçš„æ“ä½œä¸ä¼šå½±å“åˆ°å®å‚ã€‚</p>
<h2 id="å“ˆå¸Œå‡½æ•°">å“ˆå¸Œå‡½æ•°</h2>
<p>map çš„ä¸€ä¸ªå…³é”®ç‚¹åœ¨äºï¼Œå“ˆå¸Œå‡½æ•°çš„é€‰æ‹©ã€‚åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹ cpu æ˜¯å¦æ”¯æŒ aesï¼Œå¦‚æœæ”¯æŒï¼Œåˆ™ä½¿ç”¨ aes hashï¼Œå¦åˆ™ä½¿ç”¨ memhashã€‚è¿™æ˜¯åœ¨å‡½æ•° <code>alginit()</code> ä¸­å®Œæˆï¼Œä½äºè·¯å¾„ï¼š<code>src/runtime/alg.go</code> ä¸‹ã€‚</p>
<blockquote>
<p>hash å‡½æ•°ï¼Œæœ‰åŠ å¯†å‹å’ŒéåŠ å¯†å‹ã€‚<br>
åŠ å¯†å‹çš„ä¸€èˆ¬ç”¨äºåŠ å¯†æ•°æ®ã€æ•°å­—æ‘˜è¦ç­‰ï¼Œå…¸å‹ä»£è¡¨å°±æ˜¯ md5ã€sha1ã€sha256ã€aes256 è¿™ç§ï¼›<br>
éåŠ å¯†å‹çš„ä¸€èˆ¬å°±æ˜¯æŸ¥æ‰¾ã€‚åœ¨ map çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œç”¨çš„æ˜¯æŸ¥æ‰¾ã€‚<br>
é€‰æ‹© hash å‡½æ•°ä¸»è¦è€ƒå¯Ÿçš„æ˜¯ä¸¤ç‚¹ï¼šæ€§èƒ½ã€ç¢°æ’æ¦‚ç‡ã€‚</p>
</blockquote>
<p>ä¹‹å‰æˆ‘ä»¬è®²è¿‡ï¼Œè¡¨ç¤ºç±»å‹çš„ç»“æ„ä½“ï¼š</p>
<pre><code class="language-go">    type _type struct {
    	size       uintptr
    	ptrdata    uintptr // size of memory prefix holding all pointers
    	hash       uint32
    	tflag      tflag
    	align      uint8
    	fieldalign uint8
    	kind       uint8
    	alg        *typeAlg
    	gcdata    *byte
    	str       nameOff
    	ptrToThis typeOff
    }
</code></pre>
<p>å…¶ä¸­ <code>alg</code> å­—æ®µå°±å’Œå“ˆå¸Œç›¸å…³ï¼Œå®ƒæ˜¯æŒ‡å‘å¦‚ä¸‹ç»“æ„ä½“çš„æŒ‡é’ˆï¼š</p>
<pre><code class="language-go">    // src/runtime/alg.go
    type typeAlg struct {
    	// (ptr to object, seed) -&gt; hash
    	hash func(unsafe.Pointer, uintptr) uintptr
    	// (ptr to object A, ptr to object B) -&gt; ==?
    	equal func(unsafe.Pointer, unsafe.Pointer) bool
    }
</code></pre>
<p>typeAlg åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼Œhash å‡½æ•°è®¡ç®—ç±»å‹çš„å“ˆå¸Œå€¼ï¼Œè€Œ equal å‡½æ•°åˆ™è®¡ç®—ä¸¤ä¸ªç±»å‹æ˜¯å¦ â€œå“ˆå¸Œç›¸ç­‰â€ã€‚</p>
<p>å¯¹äº string ç±»å‹ï¼Œå®ƒçš„ hashã€equal å‡½æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    func strhash(a unsafe.Pointer, h uintptr) uintptr {
    	x := (*stringStruct)(a)
    	return memhash(x.str, h, uintptr(x.len))
    }
    
    func strequal(p, q unsafe.Pointer) bool {
    	return *(*string)(p) == *(*string)(q)
    }
</code></pre>
<p>æ ¹æ® key çš„ç±»å‹ï¼Œ_type ç»“æ„ä½“çš„ alg å­—æ®µä¼šè¢«è®¾ç½®å¯¹åº”ç±»å‹çš„ hash å’Œ equal å‡½æ•°ã€‚</p>
<h2 id="key-å®šä½è¿‡ç¨‹">key å®šä½è¿‡ç¨‹</h2>
<p>key ç»è¿‡å“ˆå¸Œè®¡ç®—åå¾—åˆ°å“ˆå¸Œå€¼ï¼Œå…± 64 ä¸ª bit ä½ï¼ˆ64 ä½æœºï¼Œ32 ä½æœºå°±ä¸è®¨è®ºäº†ï¼Œç°åœ¨ä¸»æµéƒ½æ˜¯ 64 ä½æœºï¼‰ï¼Œè®¡ç®—å®ƒåˆ°åº•è¦è½åœ¨å“ªä¸ªæ¡¶æ—¶ï¼Œåªä¼šç”¨åˆ°æœ€å B ä¸ª bit ä½ã€‚è¿˜è®°å¾—å‰é¢æåˆ°è¿‡çš„ B å—ï¼Ÿå¦‚æœ B = 5ï¼Œé‚£ä¹ˆæ¡¶çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ buckets æ•°ç»„çš„é•¿åº¦æ˜¯ 2^5 = 32ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç°åœ¨æœ‰ä¸€ä¸ª key ç»è¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—åï¼Œå¾—åˆ°çš„å“ˆå¸Œç»“æœæ˜¯ï¼š</p>
<pre><code class="language-go">     10010111 | 000011110110110010001111001010100010010110010101010 â”‚ 01010
</code></pre>
<p>ç”¨æœ€åçš„ 5 ä¸ª bit ä½ï¼Œä¹Ÿå°±æ˜¯ <code>01010</code>ï¼Œå€¼ä¸º 10ï¼Œä¹Ÿå°±æ˜¯ 10 å·æ¡¶ã€‚è¿™ä¸ªæ“ä½œå®é™…ä¸Šå°±æ˜¯å–ä½™æ“ä½œï¼Œä½†æ˜¯å–ä½™å¼€é”€å¤ªå¤§ï¼Œæ‰€ä»¥ä»£ç å®ç°ä¸Šç”¨çš„ä½æ“ä½œä»£æ›¿ã€‚</p>
<p>å†ç”¨å“ˆå¸Œå€¼çš„é«˜ 8 ä½ï¼Œæ‰¾åˆ°æ­¤ key åœ¨ bucket ä¸­çš„ä½ç½®ï¼Œè¿™æ˜¯åœ¨å¯»æ‰¾å·²æœ‰çš„ keyã€‚æœ€å¼€å§‹æ¡¶å†…è¿˜æ²¡æœ‰ keyï¼Œæ–°åŠ å…¥çš„ key ä¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½ï¼Œæ”¾å…¥ã€‚</p>
<p>buckets ç¼–å·å°±æ˜¯æ¡¶ç¼–å·ï¼Œå½“ä¸¤ä¸ªä¸åŒçš„ key è½åœ¨åŒä¸€ä¸ªæ¡¶ä¸­ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿäº†å“ˆå¸Œå†²çªã€‚å†²çªçš„è§£å†³æ‰‹æ®µæ˜¯ç”¨é“¾è¡¨æ³•ï¼šåœ¨ bucket ä¸­ï¼Œä»å‰å¾€åæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½ã€‚è¿™æ ·ï¼Œåœ¨æŸ¥æ‰¾æŸä¸ª key æ—¶ï¼Œå…ˆæ‰¾åˆ°å¯¹åº”çš„æ¡¶ï¼Œå†å»éå† bucket ä¸­çš„ keyã€‚</p>
<p>è¿™é‡Œå‚è€ƒæ›¹å¤§ github åšå®¢é‡Œçš„ä¸€å¼ å›¾ï¼ŒåŸå›¾æ˜¯ ascii å›¾ï¼Œgeek å‘³åè¶³ï¼Œå¯ä»¥ä»å‚è€ƒèµ„æ–™æ‰¾åˆ°æ›¹å¤§çš„åšå®¢ï¼Œæ¨èå¤§å®¶å»çœ‹çœ‹ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57577721-faf57580-74af-11e9-8826-aacdb34a1d2b.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57577721-faf57580-74af-11e9-8826-aacdb34a1d2b.png" loading="lazy" alt="mapacess">
	</a>
	
	<figcaption>mapacess</figcaption>
	
</figure><p></p>
<p>ä¸Šå›¾ä¸­ï¼Œå‡å®š B = 5ï¼Œæ‰€ä»¥ bucket æ€»æ•°å°±æ˜¯ 2^5 = 32ã€‚é¦–å…ˆè®¡ç®—å‡ºå¾…æŸ¥æ‰¾ key çš„å“ˆå¸Œï¼Œä½¿ç”¨ä½ 5 ä½ <code>00110</code>ï¼Œæ‰¾åˆ°å¯¹åº”çš„ 6 å· bucketï¼Œä½¿ç”¨é«˜ 8 ä½ <code>10010111</code>ï¼Œå¯¹åº”åè¿›åˆ¶ 151ï¼Œåœ¨ 6 å· bucket ä¸­å¯»æ‰¾ tophash å€¼ï¼ˆHOB hashï¼‰ä¸º 151 çš„ keyï¼Œæ‰¾åˆ°äº† 2 å·æ§½ä½ï¼Œè¿™æ ·æ•´ä¸ªæŸ¥æ‰¾è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p>
<p>å¦‚æœåœ¨ bucket ä¸­æ²¡æ‰¾åˆ°ï¼Œå¹¶ä¸” overflow ä¸ä¸ºç©ºï¼Œè¿˜è¦ç»§ç»­å» overflow bucket ä¸­å¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ–æ˜¯æ‰€æœ‰çš„ key æ§½ä½éƒ½æ‰¾éäº†ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„ overflow bucketã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹æºç å§ï¼Œå“ˆå“ˆï¼é€šè¿‡æ±‡ç¼–è¯­è¨€å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥æ‰¾æŸä¸ª key çš„åº•å±‚å‡½æ•°æ˜¯ <code>mapacess</code> ç³»åˆ—å‡½æ•°ï¼Œå‡½æ•°çš„ä½œç”¨ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨ä¸‹ä¸€èŠ‚ä¼šè®²åˆ°ã€‚è¿™é‡Œæˆ‘ä»¬ç›´æ¥çœ‹ <code>mapacess1</code> å‡½æ•°ï¼š</p>
<pre><code class="language-go">    func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer {
    	// â€¦â€¦
    	
    	// å¦‚æœ h ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿”å›é›¶å€¼
    	if h == nil || h.count == 0 {
    		return unsafe.Pointer(&amp;zeroVal[0])
    	}
    	
    	// å†™å’Œè¯»å†²çª
    	if h.flags&amp;hashWriting != 0 {
    		throw("concurrent map read and map write")
    	}
    	
    	// ä¸åŒç±»å‹ key ä½¿ç”¨çš„ hash ç®—æ³•åœ¨ç¼–è¯‘æœŸç¡®å®š
    	alg := t.key.alg
    	
    	// è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¹¶ä¸”åŠ å…¥ hash0 å¼•å…¥éšæœºæ€§
    	hash := alg.hash(key, uintptr(h.hash0))
    	
    	// æ¯”å¦‚ B=5ï¼Œé‚£ m å°±æ˜¯31ï¼ŒäºŒè¿›åˆ¶æ˜¯å…¨ 1
    	// æ±‚ bucket num æ—¶ï¼Œå°† hash ä¸ m ç›¸ä¸ï¼Œ
    	// è¾¾åˆ° bucket num ç”± hash çš„ä½ 8 ä½å†³å®šçš„æ•ˆæœ
    	m := uintptr(1)&lt;&lt;h.B - 1
    	
    	// b å°±æ˜¯ bucket çš„åœ°å€
    	b := (*bmap)(add(h.buckets, (hash&amp;m)*uintptr(t.bucketsize)))
    	
    	// oldbuckets ä¸ä¸º nilï¼Œè¯´æ˜å‘ç”Ÿäº†æ‰©å®¹
    	if c := h.oldbuckets; c != nil {
    	    // å¦‚æœä¸æ˜¯åŒ size æ‰©å®¹ï¼ˆçœ‹åé¢æ‰©å®¹çš„å†…å®¹ï¼‰
    	    // å¯¹åº”æ¡ä»¶ 1 çš„è§£å†³æ–¹æ¡ˆ
    		if !h.sameSizeGrow() {
    			// æ–° bucket æ•°é‡æ˜¯è€çš„ 2 å€
    			m &gt;&gt;= 1
    		}
    		
    		// æ±‚å‡º key åœ¨è€çš„ map ä¸­çš„ bucket ä½ç½®
    		oldb := (*bmap)(add(c, (hash&amp;m)*uintptr(t.bucketsize)))
    		
    		// å¦‚æœ oldb æ²¡æœ‰æ¬è¿åˆ°æ–°çš„ bucket
    		// é‚£å°±åœ¨è€çš„ bucket ä¸­å¯»æ‰¾
    		if !evacuated(oldb) {
    			b = oldb
    		}
    	}
    	
    	// è®¡ç®—å‡ºé«˜ 8 ä½çš„ hash
    	// ç›¸å½“äºå³ç§» 56 ä½ï¼Œåªå–é«˜8ä½
    	top := uint8(hash &gt;&gt; (sys.PtrSize*8 - 8))
    	
    	// å¢åŠ ä¸€ä¸ª minTopHash
    	if top &lt; minTopHash {
    		top += minTopHash
    	}
    	for {
    	    // éå† 8 ä¸ª bucket
    		for i := uintptr(0); i &lt; bucketCnt; i++ {
    		    // tophash ä¸åŒ¹é…ï¼Œç»§ç»­
    			if b.tophash[i] != top {
    				continue
    			}
    			// tophash åŒ¹é…ï¼Œå®šä½åˆ° key çš„ä½ç½®
    			k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))
    			// key æ˜¯æŒ‡é’ˆ
    			if t.indirectkey {
    			    // è§£å¼•ç”¨
    				k = *((*unsafe.Pointer)(k))
    			}
    			// å¦‚æœ key ç›¸ç­‰
    			if alg.equal(key, k) {
    			    // å®šä½åˆ° value çš„ä½ç½®
    				v := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.valuesize))
    				// value è§£å¼•ç”¨
    				if t.indirectvalue {
    					v = *((*unsafe.Pointer)(v))
    				}
    				return v
    			}
    		}
    		
    		// bucket æ‰¾å®Œï¼ˆè¿˜æ²¡æ‰¾åˆ°ï¼‰ï¼Œç»§ç»­åˆ° overflow bucket é‡Œæ‰¾
    		b = b.overflow(t)
    		// overflow bucket ä¹Ÿæ‰¾å®Œäº†ï¼Œè¯´æ˜æ²¡æœ‰ç›®æ ‡ key
    		// è¿”å›é›¶å€¼
    		if b == nil {
    			return unsafe.Pointer(&amp;zeroVal[0])
    		}
    	}
    }
</code></pre>
<p>å‡½æ•°è¿”å› h[key] çš„æŒ‡é’ˆï¼Œå¦‚æœ h ä¸­æ²¡æœ‰æ­¤ keyï¼Œé‚£å°±ä¼šè¿”å›ä¸€ä¸ª key ç›¸åº”ç±»å‹çš„é›¶å€¼ï¼Œä¸ä¼šè¿”å› nilã€‚</p>
<p>ä»£ç æ•´ä½“æ¯”è¾ƒç›´æ¥ï¼Œæ²¡ä»€ä¹ˆéš¾æ‡‚çš„åœ°æ–¹ã€‚è·Ÿç€ä¸Šé¢çš„æ³¨é‡Šä¸€æ­¥æ­¥ç†è§£å°±å¥½äº†ã€‚</p>
<p>è¿™é‡Œï¼Œè¯´ä¸€ä¸‹å®šä½ key å’Œ value çš„æ–¹æ³•ä»¥åŠæ•´ä¸ªå¾ªç¯çš„å†™æ³•ã€‚</p>
<pre><code class="language-go">    // key å®šä½å…¬å¼
    k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize))
    
    // value å®šä½å…¬å¼
    v := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.valuesize))
</code></pre>
<p>b æ˜¯ bmap çš„åœ°å€ï¼Œè¿™é‡Œ bmap è¿˜æ˜¯æºç é‡Œå®šä¹‰çš„ç»“æ„ä½“ï¼ŒåªåŒ…å«ä¸€ä¸ª tophash æ•°ç»„ï¼Œç»ç¼–è¯‘å™¨æ‰©å……ä¹‹åçš„ç»“æ„ä½“æ‰åŒ…å« keyï¼Œvalueï¼Œoverflow è¿™äº›å­—æ®µã€‚dataOffset æ˜¯ key ç›¸å¯¹äº bmap èµ·å§‹åœ°å€çš„åç§»ï¼š</p>
<pre><code class="language-go">    dataOffset = unsafe.Offsetof(struct {
    		b bmap
    		v int64
    	}{}.v)
</code></pre>
<p>å› æ­¤ bucket é‡Œ key çš„èµ·å§‹åœ°å€å°±æ˜¯ unsafe.Pointer(b)+dataOffsetã€‚ç¬¬ i ä¸ª key çš„åœ°å€å°±è¦åœ¨æ­¤åŸºç¡€ä¸Šè·¨è¿‡ i ä¸ª key çš„å¤§å°ï¼›è€Œæˆ‘ä»¬åˆçŸ¥é“ï¼Œvalue çš„åœ°å€æ˜¯åœ¨æ‰€æœ‰ key ä¹‹åï¼Œå› æ­¤ç¬¬ i ä¸ª value çš„åœ°å€è¿˜éœ€è¦åŠ ä¸Šæ‰€æœ‰ key çš„åç§»ã€‚ç†è§£äº†è¿™äº›ï¼Œä¸Šé¢ key å’Œ value çš„å®šä½å…¬å¼å°±å¾ˆå¥½ç†è§£äº†ã€‚</p>
<p>å†è¯´æ•´ä¸ªå¤§å¾ªç¯çš„å†™æ³•ï¼Œæœ€å¤–å±‚æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œé€šè¿‡</p>
<pre><code class="language-go">    b = b.overflow(t)
</code></pre>
<p>éå†æ‰€æœ‰çš„ bucketï¼Œè¿™ç›¸å½“äºæ˜¯ä¸€ä¸ª bucket é“¾è¡¨ã€‚</p>
<p>å½“å®šä½åˆ°ä¸€ä¸ªå…·ä½“çš„ bucket æ—¶ï¼Œé‡Œå±‚å¾ªç¯å°±æ˜¯éå†è¿™ä¸ª bucket é‡Œæ‰€æœ‰çš„ cellï¼Œæˆ–è€…è¯´æ‰€æœ‰çš„æ§½ä½ï¼Œä¹Ÿå°±æ˜¯ bucketCnt=8 ä¸ªæ§½ä½ã€‚æ•´ä¸ªå¾ªç¯è¿‡ç¨‹ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57581783-fe5c2180-74ee-11e9-99c9-5a226216e1af.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57581783-fe5c2180-74ee-11e9-99c9-5a226216e1af.png" loading="lazy" alt="mapacess loop">
	</a>
	
	<figcaption>mapacess loop</figcaption>
	
</figure><p></p>
<p>å†è¯´ä¸€ä¸‹ minTopHashï¼Œå½“ä¸€ä¸ª cell çš„ tophash å€¼å°äº minTopHash æ—¶ï¼Œæ ‡å¿—è¿™ä¸ª cell çš„è¿ç§»çŠ¶æ€ã€‚å› ä¸ºè¿™ä¸ªçŠ¶æ€å€¼æ˜¯æ”¾åœ¨ tophash æ•°ç»„é‡Œï¼Œä¸ºäº†å’Œæ­£å¸¸çš„å“ˆå¸Œå€¼åŒºåˆ†å¼€ï¼Œä¼šç»™ key è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¸€ä¸ªå¢é‡ï¼šminTopHashã€‚è¿™æ ·å°±èƒ½åŒºåˆ†æ­£å¸¸çš„ top hash å€¼å’Œè¡¨ç¤ºçŠ¶æ€çš„å“ˆå¸Œå€¼ã€‚</p>
<p>ä¸‹é¢çš„è¿™å‡ ç§çŠ¶æ€å°±è¡¨å¾äº† bucket çš„æƒ…å†µï¼š</p>
<pre><code class="language-go">    // ç©ºçš„ cellï¼Œä¹Ÿæ˜¯åˆå§‹æ—¶ bucket çš„çŠ¶æ€
    empty          = 0
    // ç©ºçš„ cellï¼Œè¡¨ç¤º cell å·²ç»è¢«è¿ç§»åˆ°æ–°çš„ bucket
    evacuatedEmpty = 1
    // key,value å·²ç»æ¬è¿å®Œæ¯•ï¼Œä½†æ˜¯ key éƒ½åœ¨æ–° bucket å‰åŠéƒ¨åˆ†ï¼Œ
    // åé¢æ‰©å®¹éƒ¨åˆ†ä¼šå†è®²åˆ°ã€‚
    evacuatedX     = 2
    // åŒä¸Šï¼Œkey åœ¨ååŠéƒ¨åˆ†
    evacuatedY     = 3
    // tophash çš„æœ€å°æ­£å¸¸å€¼
    minTopHash     = 4
</code></pre>
<p>æºç é‡Œåˆ¤æ–­è¿™ä¸ª bucket æ˜¯å¦å·²ç»æ¬è¿å®Œæ¯•ï¼Œç”¨åˆ°çš„å‡½æ•°ï¼š</p>
<pre><code class="language-go">    func evacuated(b *bmap) bool {
    	h := b.tophash[0]
    	return h &gt; empty &amp;&amp; h &lt; minTopHash
    }
</code></pre>
<p>åªå–äº† tophash æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦åœ¨ 0-4 ä¹‹é—´ã€‚å¯¹æ¯”ä¸Šé¢çš„å¸¸é‡ï¼Œå½“ top hash æ˜¯ <code>evacuatedEmpty</code>ã€<code>evacuatedX</code>ã€<code>evacuatedY</code> è¿™ä¸‰ä¸ªå€¼ä¹‹ä¸€ï¼Œè¯´æ˜æ­¤ bucket ä¸­çš„ key å…¨éƒ¨è¢«æ¬è¿åˆ°äº†æ–° bucketã€‚</p>
<h2 id="map-çš„ä¸¤ç§-get-æ“ä½œ">map çš„ä¸¤ç§ get æ“ä½œ</h2>
<p>Go è¯­è¨€ä¸­è¯»å– map æœ‰ä¸¤ç§è¯­æ³•ï¼šå¸¦ comma å’Œ ä¸å¸¦ commaã€‚å½“è¦æŸ¥è¯¢çš„ key ä¸åœ¨ map é‡Œï¼Œå¸¦ comma çš„ç”¨æ³•ä¼šè¿”å›ä¸€ä¸ª bool å‹å˜é‡æç¤º key æ˜¯å¦åœ¨ map ä¸­ï¼›è€Œä¸å¸¦ comma çš„è¯­å¥åˆ™ä¼šè¿”å›ä¸€ä¸ª value ç±»å‹çš„é›¶å€¼ã€‚å¦‚æœ value æ˜¯ int å‹å°±ä¼šè¿”å› 0ï¼Œå¦‚æœ value æ˜¯ string ç±»å‹ï¼Œå°±ä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</p>
<pre><code class="language-go">    package main
    
    import "fmt"
    
    func main() {
    	ageMap := make(map[string]int)
    	ageMap["qcrao"] = 18
    
        // ä¸å¸¦ comma ç”¨æ³•
    	age1 := ageMap["stefno"]
    	fmt.Println(age1)
    
        // å¸¦ comma ç”¨æ³•
    	age2, ok := ageMap["stefno"]
    	fmt.Println(age2, ok)
    }
</code></pre>
<p>è¿è¡Œç»“æœï¼š</p>
<pre><code class="language-go">    0
    0 false
</code></pre>
<p>ä»¥å‰ä¸€ç›´è§‰å¾—å¥½ç¥å¥‡ï¼Œæ€ä¹ˆå®ç°çš„ï¼Ÿè¿™å…¶å®æ˜¯ç¼–è¯‘å™¨åœ¨èƒŒååšçš„å·¥ä½œï¼šåˆ†æä»£ç åï¼Œå°†ä¸¤ç§è¯­æ³•å¯¹åº”åˆ°åº•å±‚ä¸¤ä¸ªä¸åŒçš„å‡½æ•°ã€‚</p>
<pre><code class="language-go">    // src/runtime/hashmap.go
    func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer
    func mapaccess2(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, bool)
</code></pre>
<p>æºç é‡Œï¼Œå‡½æ•°å‘½åä¸æ‹˜å°èŠ‚ï¼Œç›´æ¥å¸¦ä¸Šåç¼€ 1ï¼Œ2ï¼Œå®Œå…¨ä¸ç†ä¼šã€Šä»£ç å¤§å…¨ã€‹é‡Œçš„é‚£ä¸€å¥—å‘½åçš„åšæ³•ã€‚ä»ä¸Šé¢ä¸¤ä¸ªå‡½æ•°çš„å£°æ˜ä¹Ÿå¯ä»¥çœ‹å‡ºå·®åˆ«äº†ï¼Œ<code>mapaccess2</code> å‡½æ•°è¿”å›å€¼å¤šäº†ä¸€ä¸ª bool å‹å˜é‡ï¼Œä¸¤è€…çš„ä»£ç ä¹Ÿæ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªæ˜¯åœ¨è¿”å›å€¼åé¢å¤šåŠ äº†ä¸€ä¸ª false æˆ–è€… trueã€‚</p>
<p>å¦å¤–ï¼Œæ ¹æ® key çš„ä¸åŒç±»å‹ï¼Œç¼–è¯‘å™¨è¿˜ä¼šå°†æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤çš„å‡½æ•°ç”¨æ›´å…·ä½“çš„å‡½æ•°æ›¿æ¢ï¼Œä»¥ä¼˜åŒ–æ•ˆç‡ï¼š</p>
<p>key ç±»å‹</p>
<p>æŸ¥æ‰¾</p>
<pre><code class="language-go">uint32

mapaccess1_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer```

uint32

mapaccess2_fast32(t *maptype, h *hmap, key uint32) (unsafe.Pointer, bool)

uint64

mapaccess1_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer

uint64

mapaccess2_fast64(t *maptype, h *hmap, key uint64) (unsafe.Pointer, bool)

string

mapaccess1_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer

string

mapaccess2_faststr(t *maptype, h *hmap, ky string) (unsafe.Pointer, bool)
</code></pre>
<p>è¿™äº›å‡½æ•°çš„å‚æ•°ç±»å‹ç›´æ¥æ˜¯å…·ä½“çš„ uint32ã€unt64ã€stringï¼Œåœ¨å‡½æ•°å†…éƒ¨ç”±äºæå‰çŸ¥æ™“äº† key çš„ç±»å‹ï¼Œæ‰€ä»¥å†…å­˜å¸ƒå±€æ˜¯å¾ˆæ¸…æ¥šçš„ï¼Œå› æ­¤èƒ½èŠ‚çœå¾ˆå¤šæ“ä½œï¼Œæé«˜æ•ˆç‡ã€‚</p>
<p>ä¸Šé¢è¿™äº›å‡½æ•°éƒ½æ˜¯åœ¨æ–‡ä»¶ <code>src/runtime/hashmap_fast.go</code> é‡Œã€‚</p>
<h2 id="å¦‚ä½•è¿›è¡Œæ‰©å®¹">å¦‚ä½•è¿›è¡Œæ‰©å®¹</h2>
<p>ä½¿ç”¨å“ˆå¸Œè¡¨çš„ç›®çš„å°±æ˜¯è¦å¿«é€ŸæŸ¥æ‰¾åˆ°ç›®æ ‡ keyï¼Œç„¶è€Œï¼Œéšç€å‘ map ä¸­æ·»åŠ çš„ key è¶Šæ¥è¶Šå¤šï¼Œkey å‘ç”Ÿç¢°æ’çš„æ¦‚ç‡ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚bucket ä¸­çš„ 8 ä¸ª cell ä¼šè¢«é€æ¸å¡æ»¡ï¼ŒæŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ key çš„æ•ˆç‡ä¹Ÿä¼šè¶Šæ¥è¶Šä½ã€‚æœ€ç†æƒ³çš„æƒ…å†µæ˜¯ä¸€ä¸ª bucket åªè£…ä¸€ä¸ª keyï¼Œè¿™æ ·ï¼Œå°±èƒ½è¾¾åˆ° <code>O(1)</code> çš„æ•ˆç‡ï¼Œä½†è¿™æ ·ç©ºé—´æ¶ˆè€—å¤ªå¤§ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´çš„ä»£ä»·å¤ªé«˜ã€‚</p>
<p>Go è¯­è¨€é‡‡ç”¨ä¸€ä¸ª bucket é‡Œè£…è½½ 8 ä¸ª keyï¼Œå®šä½åˆ°æŸä¸ª bucket åï¼Œè¿˜éœ€è¦å†å®šä½åˆ°å…·ä½“çš„ keyï¼Œè¿™å®é™…ä¸Šåˆç”¨äº†æ—¶é—´æ¢ç©ºé—´ã€‚</p>
<p>å½“ç„¶ï¼Œè¿™æ ·åšï¼Œè¦æœ‰ä¸€ä¸ªåº¦ï¼Œä¸ç„¶æ‰€æœ‰çš„ key éƒ½è½åœ¨äº†åŒä¸€ä¸ª bucket é‡Œï¼Œç›´æ¥é€€åŒ–æˆäº†é“¾è¡¨ï¼Œå„ç§æ“ä½œçš„æ•ˆç‡ç›´æ¥é™ä¸º O(n)ï¼Œæ˜¯ä¸è¡Œçš„ã€‚</p>
<p>å› æ­¤ï¼Œéœ€è¦æœ‰ä¸€ä¸ªæŒ‡æ ‡æ¥è¡¡é‡å‰é¢æè¿°çš„æƒ…å†µï¼Œè¿™å°±æ˜¯<code>è£…è½½å› å­</code>ã€‚Go æºç é‡Œè¿™æ ·å®šä¹‰ <code>è£…è½½å› å­</code>ï¼š</p>
<pre><code class="language-go">    loadFactor := count / (2^B)
</code></pre>
<p>count å°±æ˜¯ map çš„å…ƒç´ ä¸ªæ•°ï¼Œ2^B è¡¨ç¤º bucket æ•°é‡ã€‚</p>
<p>å†æ¥è¯´è§¦å‘ map æ‰©å®¹çš„æ—¶æœºï¼šåœ¨å‘ map æ’å…¥æ–° key çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œæ¡ä»¶æ£€æµ‹ï¼Œç¬¦åˆä¸‹é¢è¿™ 2 ä¸ªæ¡ä»¶ï¼Œå°±ä¼šè§¦å‘æ‰©å®¹ï¼š</p>
<ol>
<li>è£…è½½å› å­è¶…è¿‡é˜ˆå€¼ï¼Œæºç é‡Œå®šä¹‰çš„é˜ˆå€¼æ˜¯ 6.5ã€‚</li>
<li>overflow çš„ bucket æ•°é‡è¿‡å¤šï¼šå½“ B å°äº 15ï¼Œä¹Ÿå°±æ˜¯ bucket æ€»æ•° 2^B å°äº 2^15 æ—¶ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^Bï¼›å½“ B &gt;= 15ï¼Œä¹Ÿå°±æ˜¯ bucket æ€»æ•° 2^B å¤§äºç­‰äº 2^15ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^15ã€‚</li>
</ol>
<p>é€šè¿‡æ±‡ç¼–è¯­è¨€å¯ä»¥æ‰¾åˆ°èµ‹å€¼æ“ä½œå¯¹åº”æºç ä¸­çš„å‡½æ•°æ˜¯ <code>mapassign</code>ï¼Œå¯¹åº”æ‰©å®¹æ¡ä»¶çš„æºç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    // src/runtime/hashmap.go/mapassign
    
    // è§¦å‘æ‰©å®¹æ—¶æœº
    if !h.growing() &amp;&amp; (overLoadFactor(int64(h.count), h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) {
    		hashGrow(t, h)
    	}
    
    // è£…è½½å› å­è¶…è¿‡ 6.5
    func overLoadFactor(count int64, B uint8) bool {
    	return count &gt;= bucketCnt &amp;&amp; float32(count) &gt;= loadFactor*float32((uint64(1)&lt;&lt;B))
    }
    
    // overflow buckets å¤ªå¤š
    func tooManyOverflowBuckets(noverflow uint16, B uint8) bool {
    	if B &lt; 16 {
    		return noverflow &gt;= uint16(1)&lt;&lt;B
    	}
    	return noverflow &gt;= 1&lt;&lt;15
    }
</code></pre>
<p>è§£é‡Šä¸€ä¸‹ï¼š</p>
<p>ç¬¬ 1 ç‚¹ï¼šæˆ‘ä»¬çŸ¥é“ï¼Œæ¯ä¸ª bucket æœ‰ 8 ä¸ªç©ºä½ï¼Œåœ¨æ²¡æœ‰æº¢å‡ºï¼Œä¸”æ‰€æœ‰çš„æ¡¶éƒ½è£…æ»¡äº†çš„æƒ…å†µä¸‹ï¼Œè£…è½½å› å­ç®—å‡ºæ¥çš„ç»“æœæ˜¯ 8ã€‚å› æ­¤å½“è£…è½½å› å­è¶…è¿‡ 6.5 æ—¶ï¼Œè¡¨æ˜å¾ˆå¤š bucket éƒ½å¿«è¦è£…æ»¡äº†ï¼ŒæŸ¥æ‰¾æ•ˆç‡å’Œæ’å…¥æ•ˆç‡éƒ½å˜ä½äº†ã€‚åœ¨è¿™ä¸ªæ—¶å€™è¿›è¡Œæ‰©å®¹æ˜¯æœ‰å¿…è¦çš„ã€‚</p>
<p>ç¬¬ 2 ç‚¹ï¼šæ˜¯å¯¹ç¬¬ 1 ç‚¹çš„è¡¥å……ã€‚å°±æ˜¯è¯´åœ¨è£…è½½å› å­æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œè¿™æ—¶å€™ map çš„æŸ¥æ‰¾å’Œæ’å…¥æ•ˆç‡ä¹Ÿå¾ˆä½ï¼Œè€Œç¬¬ 1 ç‚¹è¯†åˆ«ä¸å‡ºæ¥è¿™ç§æƒ…å†µã€‚è¡¨é¢ç°è±¡å°±æ˜¯è®¡ç®—è£…è½½å› å­çš„åˆ†å­æ¯”è¾ƒå°ï¼Œå³ map é‡Œå…ƒç´ æ€»æ•°å°‘ï¼Œä½†æ˜¯ bucket æ•°é‡å¤šï¼ˆçœŸå®åˆ†é…çš„ bucket æ•°é‡å¤šï¼ŒåŒ…æ‹¬å¤§é‡çš„ overflow bucketï¼‰ã€‚</p>
<p>ä¸éš¾æƒ³åƒé€ æˆè¿™ç§æƒ…å†µçš„åŸå› ï¼šä¸åœåœ°æ’å…¥ã€åˆ é™¤å…ƒç´ ã€‚å…ˆæ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºäº†å¾ˆå¤š bucketï¼Œä½†æ˜¯è£…è½½å› å­è¾¾ä¸åˆ°ç¬¬ 1 ç‚¹çš„ä¸´ç•Œå€¼ï¼Œæœªè§¦å‘æ‰©å®¹æ¥ç¼“è§£è¿™ç§æƒ…å†µã€‚ä¹‹åï¼Œåˆ é™¤å…ƒç´ é™ä½å…ƒç´ æ€»æ•°é‡ï¼Œå†æ’å…¥å¾ˆå¤šå…ƒç´ ï¼Œå¯¼è‡´åˆ›å»ºå¾ˆå¤šçš„ overflow bucketï¼Œä½†å°±æ˜¯ä¸ä¼šè§¦çŠ¯ç¬¬ 1 ç‚¹çš„è§„å®šï¼Œä½ èƒ½æ‹¿æˆ‘æ€ä¹ˆåŠï¼Ÿoverflow bucket æ•°é‡å¤ªå¤šï¼Œå¯¼è‡´ key ä¼šå¾ˆåˆ†æ•£ï¼ŒæŸ¥æ‰¾æ’å…¥æ•ˆç‡ä½å¾—å“äººï¼Œå› æ­¤å‡ºå°ç¬¬ 2 ç‚¹è§„å®šã€‚è¿™å°±åƒæ˜¯ä¸€åº§ç©ºåŸï¼Œæˆ¿å­å¾ˆå¤šï¼Œä½†æ˜¯ä½æˆ·å¾ˆå°‘ï¼Œéƒ½åˆ†æ•£äº†ï¼Œæ‰¾èµ·äººæ¥å¾ˆå›°éš¾ã€‚</p>
<p>å¯¹äºå‘½ä¸­æ¡ä»¶ 1ï¼Œ2 çš„é™åˆ¶ï¼Œéƒ½ä¼šå‘ç”Ÿæ‰©å®¹ã€‚ä½†æ˜¯æ‰©å®¹çš„ç­–ç•¥å¹¶ä¸ç›¸åŒï¼Œæ¯•ç«Ÿä¸¤ç§æ¡ä»¶åº”å¯¹çš„åœºæ™¯ä¸åŒã€‚</p>
<p>å¯¹äºæ¡ä»¶ 1ï¼Œå…ƒç´ å¤ªå¤šï¼Œè€Œ bucket æ•°é‡å¤ªå°‘ï¼Œå¾ˆç®€å•ï¼šå°† B åŠ  1ï¼Œbucket æœ€å¤§æ•°é‡ï¼ˆ2^Bï¼‰ç›´æ¥å˜æˆåŸæ¥ bucket æ•°é‡çš„ 2 å€ã€‚äºæ˜¯ï¼Œå°±æœ‰æ–°è€ bucket äº†ã€‚æ³¨æ„ï¼Œè¿™æ—¶å€™å…ƒç´ éƒ½åœ¨è€ bucket é‡Œï¼Œè¿˜æ²¡è¿ç§»åˆ°æ–°çš„ bucket æ¥ã€‚è€Œä¸”ï¼Œæ–° bucket åªæ˜¯æœ€å¤§æ•°é‡å˜ä¸ºåŸæ¥æœ€å¤§æ•°é‡ï¼ˆ2^Bï¼‰çš„ 2 å€ï¼ˆ2^B * 2ï¼‰ã€‚</p>
<p>å¯¹äºæ¡ä»¶ 2ï¼Œå…¶å®å…ƒç´ æ²¡é‚£ä¹ˆå¤šï¼Œä½†æ˜¯ overflow bucket æ•°ç‰¹åˆ«å¤šï¼Œè¯´æ˜å¾ˆå¤š bucket éƒ½æ²¡è£…æ»¡ã€‚è§£å†³åŠæ³•å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªæ–° bucket ç©ºé—´ï¼Œå°†è€ bucket ä¸­çš„å…ƒç´ ç§»åŠ¨åˆ°æ–° bucketï¼Œä½¿å¾—åŒä¸€ä¸ª bucket ä¸­çš„ key æ’åˆ—åœ°æ›´ç´§å¯†ã€‚è¿™æ ·ï¼ŒåŸæ¥ï¼Œåœ¨ overflow bucket ä¸­çš„ key å¯ä»¥ç§»åŠ¨åˆ° bucket ä¸­æ¥ã€‚ç»“æœæ˜¯èŠ‚çœç©ºé—´ï¼Œæé«˜ bucket åˆ©ç”¨ç‡ï¼Œmap çš„æŸ¥æ‰¾å’Œæ’å…¥æ•ˆç‡è‡ªç„¶å°±ä¼šæå‡ã€‚</p>
<p>å¯¹äºæ¡ä»¶ 2 çš„è§£å†³æ–¹æ¡ˆï¼Œæ›¹å¤§çš„åšå®¢é‡Œè¿˜æå‡ºäº†ä¸€ä¸ªæç«¯çš„æƒ…å†µï¼šå¦‚æœæ’å…¥ map çš„ key å“ˆå¸Œéƒ½ä¸€æ ·ï¼Œå°±ä¼šè½åˆ°åŒä¸€ä¸ª bucket é‡Œï¼Œè¶…è¿‡ 8 ä¸ªå°±ä¼šäº§ç”Ÿ overflow bucketï¼Œç»“æœä¹Ÿä¼šé€ æˆ overflow bucket æ•°è¿‡å¤šã€‚ç§»åŠ¨å…ƒç´ å…¶å®è§£å†³ä¸äº†é—®é¢˜ï¼Œå› ä¸ºè¿™æ—¶æ•´ä¸ªå“ˆå¸Œè¡¨å·²ç»é€€åŒ–æˆäº†ä¸€ä¸ªé“¾è¡¨ï¼Œæ“ä½œæ•ˆç‡å˜æˆäº† <code>O(n)</code>ã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸‹æ‰©å®¹å…·ä½“æ˜¯æ€ä¹ˆåšçš„ã€‚ç”±äº map æ‰©å®¹éœ€è¦å°†åŸæœ‰çš„ key/value é‡æ–°æ¬è¿åˆ°æ–°çš„å†…å­˜åœ°å€ï¼Œå¦‚æœæœ‰å¤§é‡çš„ key/value éœ€è¦æ¬è¿ï¼Œä¼šéå¸¸å½±å“æ€§èƒ½ã€‚å› æ­¤ Go map çš„æ‰©å®¹é‡‡å–äº†ä¸€ç§ç§°ä¸º â€œæ¸è¿›å¼â€ åœ°æ–¹å¼ï¼ŒåŸæœ‰çš„ key å¹¶ä¸ä¼šä¸€æ¬¡æ€§æ¬è¿å®Œæ¯•ï¼Œæ¯æ¬¡æœ€å¤šåªä¼šæ¬è¿ 2 ä¸ª bucketã€‚</p>
<p>ä¸Šé¢è¯´çš„ <code>hashGrow()</code> å‡½æ•°å®é™…ä¸Šå¹¶æ²¡æœ‰çœŸæ­£åœ° â€œæ¬è¿â€ï¼Œå®ƒåªæ˜¯åˆ†é…å¥½äº†æ–°çš„ bucketsï¼Œå¹¶å°†è€çš„ buckets æŒ‚åˆ°äº† oldbuckets å­—æ®µä¸Šã€‚çœŸæ­£æ¬è¿ buckets çš„åŠ¨ä½œåœ¨ <code>growWork()</code> å‡½æ•°ä¸­ï¼Œè€Œè°ƒç”¨ <code>growWork()</code> å‡½æ•°çš„åŠ¨ä½œæ˜¯åœ¨ mapassign å’Œ mapdelete å‡½æ•°ä¸­ã€‚ä¹Ÿå°±æ˜¯æ’å…¥æˆ–ä¿®æ”¹ã€åˆ é™¤ key çš„æ—¶å€™ï¼Œéƒ½ä¼šå°è¯•è¿›è¡Œæ¬è¿ buckets çš„å·¥ä½œã€‚å…ˆæ£€æŸ¥ oldbuckets æ˜¯å¦æ¬è¿å®Œæ¯•ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯æ£€æŸ¥ oldbuckets æ˜¯å¦ä¸º nilã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ <code>hashGrow()</code> å‡½æ•°æ‰€åšçš„å·¥ä½œï¼Œå†æ¥çœ‹å…·ä½“çš„æ¬è¿ buckets æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚</p>
<pre><code class="language-go">    func hashGrow(t *maptype, h *hmap) {
    	// B+1 ç›¸å½“äºæ˜¯åŸæ¥ 2 å€çš„ç©ºé—´
    	bigger := uint8(1)
    
    	// å¯¹åº”æ¡ä»¶ 2
    	if !overLoadFactor(int64(h.count), h.B) {
    		// è¿›è¡Œç­‰é‡çš„å†…å­˜æ‰©å®¹ï¼Œæ‰€ä»¥ B ä¸å˜
    		bigger = 0
    		h.flags |= sameSizeGrow
    	}
    	// å°†è€ buckets æŒ‚åˆ° buckets ä¸Š
    	oldbuckets := h.buckets
    	// ç”³è¯·æ–°çš„ buckets ç©ºé—´
    	newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger)
    
    	flags := h.flags &amp;^ (iterator | oldIterator)
    	if h.flags&amp;iterator != 0 {
    		flags |= oldIterator
    	}
    	// æäº¤ grow çš„åŠ¨ä½œ
    	h.B += bigger
    	h.flags = flags
    	h.oldbuckets = oldbuckets
    	h.buckets = newbuckets
    	// æ¬è¿è¿›åº¦ä¸º 0
    	h.nevacuate = 0
    	// overflow buckets æ•°ä¸º 0
    	h.noverflow = 0
    
    	// â€¦â€¦
    }
</code></pre>
<p>ä¸»è¦æ˜¯ç”³è¯·åˆ°äº†æ–°çš„ buckets ç©ºé—´ï¼ŒæŠŠç›¸å…³çš„æ ‡å¿—ä½éƒ½è¿›è¡Œäº†å¤„ç†ï¼šä¾‹å¦‚æ ‡å¿— nevacuate è¢«ç½®ä¸º 0ï¼Œ è¡¨ç¤ºå½“å‰æ¬è¿è¿›åº¦ä¸º 0ã€‚</p>
<p>å€¼å¾—ä¸€è¯´çš„æ˜¯å¯¹ <code>h.flags</code> çš„å¤„ç†ï¼š</p>
<pre><code class="language-go">    flags := h.flags &amp;^ (iterator | oldIterator)
    if h.flags&amp;iterator != 0 {
    	flags |= oldIterator
    }
</code></pre>
<p>è¿™é‡Œå¾—å…ˆè¯´ä¸‹è¿ç®—ç¬¦ï¼š&amp;^ã€‚è¿™å«<code>æŒ‰ä½ç½® 0</code>è¿ç®—ç¬¦ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code class="language-go">    x = 01010011
    y = 01010100
    z = x &amp;^ y = 00000011
</code></pre>
<p>å¦‚æœ y bit ä½ä¸º 1ï¼Œé‚£ä¹ˆç»“æœ z å¯¹åº” bit ä½å°±ä¸º 0ï¼Œå¦åˆ™ z å¯¹åº” bit ä½å°±å’Œ x å¯¹åº” bit ä½çš„å€¼ç›¸åŒã€‚</p>
<p>æ‰€ä»¥ä¸Šé¢é‚£æ®µå¯¹ flags ä¸€é¡¿æ“ä½œçš„ä»£ç çš„æ„æ€æ˜¯ï¼šå…ˆæŠŠ h.flags ä¸­ iterator å’Œ oldIterator å¯¹åº”ä½æ¸… 0ï¼Œç„¶åå¦‚æœå‘ç° iterator ä½ä¸º 1ï¼Œé‚£å°±æŠŠå®ƒè½¬æ¥åˆ° oldIterator ä½ï¼Œä½¿å¾— oldIterator æ ‡å¿—ä½å˜æˆ 1ã€‚æ½œå°è¯å°±æ˜¯ï¼šbuckets ç°åœ¨æŒ‚åˆ°äº† oldBuckets åä¸‹äº†ï¼Œå¯¹åº”çš„æ ‡å¿—ä½ä¹Ÿè½¬æ¥è¿‡å»å§ã€‚</p>
<p>å‡ ä¸ªæ ‡å¿—ä½å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    // å¯èƒ½æœ‰è¿­ä»£å™¨ä½¿ç”¨ buckets
    iterator     = 1
    // å¯èƒ½æœ‰è¿­ä»£å™¨ä½¿ç”¨ oldbuckets
    oldIterator  = 2
    // æœ‰åç¨‹æ­£åœ¨å‘ map ä¸­å†™å…¥ key
    hashWriting  = 4
    // ç­‰é‡æ‰©å®¹ï¼ˆå¯¹åº”æ¡ä»¶ 2ï¼‰
    sameSizeGrow = 8
</code></pre>
<p>å†æ¥çœ‹çœ‹çœŸæ­£æ‰§è¡Œæ¬è¿å·¥ä½œçš„ growWork() å‡½æ•°ã€‚</p>
<pre><code class="language-go">    func growWork(t *maptype, h *hmap, bucket uintptr) {
    	// ç¡®è®¤æ¬è¿è€çš„ bucket å¯¹åº”æ­£åœ¨ä½¿ç”¨çš„ bucket
    	evacuate(t, h, bucket&amp;h.oldbucketmask())
    
    	// å†æ¬è¿ä¸€ä¸ª bucketï¼Œä»¥åŠ å¿«æ¬è¿è¿›ç¨‹
    	if h.growing() {
    		evacuate(t, h, h.nevacuate)
    	}
    }
</code></pre>
<p>h.growing() å‡½æ•°éå¸¸ç®€å•ï¼š</p>
<pre><code class="language-go">    func (h *hmap) growing() bool {
    	return h.oldbuckets != nil
    }
</code></pre>
<p>å¦‚æœ <code>oldbuckets</code> ä¸ä¸ºç©ºï¼Œè¯´æ˜è¿˜æ²¡æœ‰æ¬è¿å®Œæ¯•ï¼Œè¿˜å¾—ç»§ç»­æ¬ã€‚</p>
<p><code>bucket&amp;h.oldbucketmask()</code> è¿™è¡Œä»£ç ï¼Œå¦‚æºç æ³¨é‡Šé‡Œè¯´çš„ï¼Œæ˜¯ä¸ºäº†ç¡®è®¤æ¬è¿çš„ bucket æ˜¯æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„ bucketã€‚<code>oldbucketmask()</code> å‡½æ•°è¿”å›æ‰©å®¹å‰çš„ map çš„ bucketmaskã€‚</p>
<p>æ‰€è°“çš„ bucketmaskï¼Œä½œç”¨å°±æ˜¯å°† key è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¸ bucketmask ç›¸ä¸ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯ key åº”è¯¥è½å…¥çš„æ¡¶ã€‚æ¯”å¦‚ B = 5ï¼Œé‚£ä¹ˆ bucketmask çš„ä½ 5 ä½æ˜¯ <code>11111</code>ï¼Œå…¶ä½™ä½æ˜¯ <code>0</code>ï¼Œhash å€¼ä¸å…¶ç›¸ä¸çš„æ„æ€æ˜¯ï¼Œåªæœ‰ hash å€¼çš„ä½ 5 ä½å†³ç­– key åˆ°åº•è½å…¥å“ªä¸ª bucketã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é›†ä¸­æ‰€æœ‰çš„ç²¾åŠ›åœ¨æ¬è¿çš„å…³é”®å‡½æ•° evacuateã€‚æºç è´´åœ¨ä¸‹é¢ï¼Œä¸è¦ç´§å¼ ï¼Œæˆ‘ä¼šåŠ ä¸Šå¤§é¢ç§¯çš„æ³¨é‡Šï¼Œé€šè¿‡æ³¨é‡Šç»å¯¹æ˜¯èƒ½çœ‹æ‡‚çš„ã€‚ä¹‹åï¼Œæˆ‘ä¼šå†å¯¹æ¬è¿è¿‡ç¨‹ä½œè¯¦ç»†è¯´æ˜ã€‚</p>
<p>æºç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    func evacuate(t *maptype, h *hmap, oldbucket uintptr) {
    	// å®šä½è€çš„ bucket åœ°å€
    	b := (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.bucketsize)))
    	// ç»“æœæ˜¯ 2^Bï¼Œå¦‚ B = 5ï¼Œç»“æœä¸º32
    	newbit := h.noldbuckets()
    	// key çš„å“ˆå¸Œå‡½æ•°
    	alg := t.key.alg
    	// å¦‚æœ b æ²¡æœ‰è¢«æ¬è¿è¿‡
    	if !evacuated(b) {
    		var (
    			// è¡¨ç¤ºbucket ç§»åŠ¨çš„ç›®æ ‡åœ°å€
    			x, y   *bmap
    			// æŒ‡å‘ x,y ä¸­çš„ key/val
    			xi, yi int
    			// æŒ‡å‘ xï¼Œy ä¸­çš„ key
    			xk, yk unsafe.Pointer
    			// æŒ‡å‘ xï¼Œy ä¸­çš„ value
    			xv, yv unsafe.Pointer
    		)
    		// é»˜è®¤æ˜¯ç­‰ size æ‰©å®¹ï¼Œå‰å bucket åºå·ä¸å˜
    		// ä½¿ç”¨ x æ¥è¿›è¡Œæ¬è¿
    		x = (*bmap)(add(h.buckets, oldbucket*uintptr(t.bucketsize)))
    		xi = 0
    		xk = add(unsafe.Pointer(x), dataOffset)
    		xv = add(xk, bucketCnt*uintptr(t.keysize))ã€
    
    		// å¦‚æœä¸æ˜¯ç­‰ size æ‰©å®¹ï¼Œå‰å bucket åºå·æœ‰å˜
    		// ä½¿ç”¨ y æ¥è¿›è¡Œæ¬è¿
    		if !h.sameSizeGrow() {
    			// y ä»£è¡¨çš„ bucket åºå·å¢åŠ äº† 2^B
    			y = (*bmap)(add(h.buckets, (oldbucket+newbit)*uintptr(t.bucketsize)))
    			yi = 0
    			yk = add(unsafe.Pointer(y), dataOffset)
    			yv = add(yk, bucketCnt*uintptr(t.keysize))
    		}
    
    		// éå†æ‰€æœ‰çš„ bucketï¼ŒåŒ…æ‹¬ overflow buckets
    		// b æ˜¯è€çš„ bucket åœ°å€
    		for ; b != nil; b = b.overflow(t) {
    			k := add(unsafe.Pointer(b), dataOffset)
    			v := add(k, bucketCnt*uintptr(t.keysize))
    
    			// éå† bucket ä¸­çš„æ‰€æœ‰ cell
    			for i := 0; i &lt; bucketCnt; i, k, v = i+1, add(k, uintptr(t.keysize)), add(v, uintptr(t.valuesize)) {
    				// å½“å‰ cell çš„ top hash å€¼
    				top := b.tophash[i]
    				// å¦‚æœ cell ä¸ºç©ºï¼Œå³æ²¡æœ‰ key
    				if top == empty {
    					// é‚£å°±æ ‡å¿—å®ƒè¢«"æ¬è¿"è¿‡
    					b.tophash[i] = evacuatedEmpty
    					// ç»§ç»­ä¸‹ä¸ª cell
    					continue
    				}
    				// æ­£å¸¸ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µ
    				// æœªè¢«æ¬è¿çš„ cell åªå¯èƒ½æ˜¯ empty æˆ–æ˜¯
    				// æ­£å¸¸çš„ top hashï¼ˆå¤§äº minTopHashï¼‰
    				if top &lt; minTopHash {
    					throw("bad map state")
    				}
    
    				k2 := k
    				// å¦‚æœ key æ˜¯æŒ‡é’ˆï¼Œåˆ™è§£å¼•ç”¨
    				if t.indirectkey {
    					k2 = *((*unsafe.Pointer)(k2))
    				}
    
    				// é»˜è®¤ä½¿ç”¨ Xï¼Œç­‰é‡æ‰©å®¹
    				useX := true
    				// å¦‚æœä¸æ˜¯ç­‰é‡æ‰©å®¹
    				if !h.sameSizeGrow() {
    					// è®¡ç®— hash å€¼ï¼Œå’Œ key ç¬¬ä¸€æ¬¡å†™å…¥æ—¶ä¸€æ ·
    					hash := alg.hash(k2, uintptr(h.hash0))
    
    					// å¦‚æœæœ‰åç¨‹æ­£åœ¨éå† map
    					if h.flags&amp;iterator != 0 {
    						// å¦‚æœå‡ºç° ç›¸åŒçš„ key å€¼ï¼Œç®—å‡ºæ¥çš„ hash å€¼ä¸åŒ
    						if !t.reflexivekey &amp;&amp; !alg.equal(k2, k2) {
    							// åªæœ‰åœ¨ float å˜é‡çš„ NaN() æƒ…å†µä¸‹ä¼šå‡ºç°
    							if top&amp;1 != 0 {
    								// ç¬¬ B ä½ç½® 1
    								hash |= newbit
    							} else {
    								// ç¬¬ B ä½ç½® 0
    								hash &amp;^= newbit
    							}
    							// å–é«˜ 8 ä½ä½œä¸º top hash å€¼
    							top = uint8(hash &gt;&gt; (sys.PtrSize*8 - 8))
    							if top &lt; minTopHash {
    								top += minTopHash
    							}
    						}
    					}
    
    					// å–å†³äºæ–°å“ˆå¸Œå€¼çš„ oldB+1 ä½æ˜¯ 0 è¿˜æ˜¯ 1
    					// è¯¦ç»†çœ‹åé¢çš„æ–‡ç« 
    					useX = hash&amp;newbit == 0
    				}
    
    				// å¦‚æœ key æ¬åˆ° X éƒ¨åˆ†
    				if useX {
    					// æ ‡å¿—è€çš„ cell çš„ top hash å€¼ï¼Œè¡¨ç¤ºæ¬ç§»åˆ° X éƒ¨åˆ†
    					b.tophash[i] = evacuatedX
    					// å¦‚æœ xi ç­‰äº 8ï¼Œè¯´æ˜è¦æº¢å‡ºäº†
    					if xi == bucketCnt {
    						// æ–°å»ºä¸€ä¸ª bucket
    						newx := h.newoverflow(t, x)
    						x = newx
    						// xi ä» 0 å¼€å§‹è®¡æ•°
    						xi = 0
    						// xk è¡¨ç¤º key è¦ç§»åŠ¨åˆ°çš„ä½ç½®
    						xk = add(unsafe.Pointer(x), dataOffset)
    						// xv è¡¨ç¤º value è¦ç§»åŠ¨åˆ°çš„ä½ç½®
    						xv = add(xk, bucketCnt*uintptr(t.keysize))
    					}
    					// è®¾ç½® top hash å€¼
    					x.tophash[xi] = top
    					// key æ˜¯æŒ‡é’ˆ
    					if t.indirectkey {
    						// å°†åŸ keyï¼ˆæ˜¯æŒ‡é’ˆï¼‰å¤åˆ¶åˆ°æ–°ä½ç½®
    						*(*unsafe.Pointer)(xk) = k2 // copy pointer
    					} else {
    						// å°†åŸ keyï¼ˆæ˜¯å€¼ï¼‰å¤åˆ¶åˆ°æ–°ä½ç½®
    						typedmemmove(t.key, xk, k) // copy value
    					}
    					// value æ˜¯æŒ‡é’ˆï¼Œæ“ä½œåŒ key
    					if t.indirectvalue {
    						*(*unsafe.Pointer)(xv) = *(*unsafe.Pointer)(v)
    					} else {
    						typedmemmove(t.elem, xv, v)
    					}
    
    					// å®šä½åˆ°ä¸‹ä¸€ä¸ª cell
    					xi++
    					xk = add(xk, uintptr(t.keysize))
    					xv = add(xv, uintptr(t.valuesize))
    				} else { // key æ¬åˆ° Y éƒ¨åˆ†ï¼Œæ“ä½œåŒ X éƒ¨åˆ†
    					// â€¦â€¦
    					// çœç•¥äº†è¿™éƒ¨åˆ†ï¼Œæ“ä½œå’Œ X éƒ¨åˆ†ç›¸åŒ
    				}
    			}
    		}
    		// å¦‚æœæ²¡æœ‰åç¨‹åœ¨ä½¿ç”¨è€çš„ bucketsï¼Œå°±æŠŠè€ buckets æ¸…é™¤æ‰ï¼Œå¸®åŠ©gc
    		if h.flags&amp;oldIterator == 0 {
    			b = (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.bucketsize)))
    			// åªæ¸…é™¤bucket çš„ key,value éƒ¨åˆ†ï¼Œä¿ç•™ top hash éƒ¨åˆ†ï¼ŒæŒ‡ç¤ºæ¬è¿çŠ¶æ€
    			if t.bucket.kind&amp;kindNoPointers == 0 {
    				memclrHasPointers(add(unsafe.Pointer(b), dataOffset), uintptr(t.bucketsize)-dataOffset)
    			} else {
    				memclrNoHeapPointers(add(unsafe.Pointer(b), dataOffset), uintptr(t.bucketsize)-dataOffset)
    			}
    		}
    	}
    
    	// æ›´æ–°æ¬è¿è¿›åº¦
    	// å¦‚æœæ­¤æ¬¡æ¬è¿çš„ bucket ç­‰äºå½“å‰è¿›åº¦
    	if oldbucket == h.nevacuate {
    		// è¿›åº¦åŠ  1
    		h.nevacuate = oldbucket + 1
    		// Experiments suggest that 1024 is overkill by at least an order of magnitude.
    		// Put it in there as a safeguard anyway, to ensure O(1) behavior.
    		// å°è¯•å¾€åçœ‹ 1024 ä¸ª bucket
    		stop := h.nevacuate + 1024
    		if stop &gt; newbit {
    			stop = newbit
    		}
    		// å¯»æ‰¾æ²¡æœ‰æ¬è¿çš„ bucket
    		for h.nevacuate != stop &amp;&amp; bucketEvacuated(t, h, h.nevacuate) {
    			h.nevacuate++
    		}
    		
    		// ç°åœ¨ h.nevacuate ä¹‹å‰çš„ bucket éƒ½è¢«æ¬è¿å®Œæ¯•
    		
    		// æ‰€æœ‰çš„ buckets æ¬è¿å®Œæ¯•
    		if h.nevacuate == newbit {
    			// æ¸…é™¤è€çš„ buckets
    			h.oldbuckets = nil
    			// æ¸…é™¤è€çš„ overflow bucket
    			// å›å¿†ä¸€ä¸‹ï¼š[0] è¡¨ç¤ºå½“å‰ overflow bucket
    			// [1] è¡¨ç¤º old overflow bucket
    			if h.extra != nil {
    				h.extra.overflow[1] = nil
    			}
    			// æ¸…é™¤æ­£åœ¨æ‰©å®¹çš„æ ‡å¿—ä½
    			h.flags &amp;^= sameSizeGrow
    		}
    	}
    }
</code></pre>
<p>evacuate å‡½æ•°çš„ä»£ç æ³¨é‡Šéå¸¸æ¸…æ™°ï¼Œå¯¹ç€ä»£ç å’Œæ³¨é‡Šæ˜¯å¾ˆå®¹æ˜“çœ‹æ‡‚æ•´ä¸ªçš„æ¬è¿è¿‡ç¨‹çš„ï¼Œè€å¿ƒç‚¹ã€‚</p>
<p>æ¬è¿çš„ç›®çš„å°±æ˜¯å°†è€çš„ buckets æ¬è¿åˆ°æ–°çš„ bucketsã€‚è€Œé€šè¿‡å‰é¢çš„è¯´æ˜æˆ‘ä»¬çŸ¥é“ï¼Œåº”å¯¹æ¡ä»¶ 1ï¼Œæ–°çš„ buckets æ•°é‡æ˜¯ä¹‹å‰çš„ä¸€å€ï¼Œåº”å¯¹æ¡ä»¶ 2ï¼Œæ–°çš„ buckets æ•°é‡å’Œä¹‹å‰ç›¸ç­‰ã€‚</p>
<p>å¯¹äºæ¡ä»¶ 2ï¼Œä»è€çš„ buckets æ¬è¿åˆ°æ–°çš„ bucketsï¼Œç”±äº bucktes æ•°é‡ä¸å˜ï¼Œå› æ­¤å¯ä»¥æŒ‰åºå·æ¥æ¬ï¼Œæ¯”å¦‚åŸæ¥åœ¨ 0 å· bucktesï¼Œåˆ°æ–°çš„åœ°æ–¹åï¼Œä»ç„¶æ”¾åœ¨ 0 å· bucketsã€‚</p>
<p>å¯¹äºæ¡ä»¶ 1ï¼Œå°±æ²¡è¿™ä¹ˆç®€å•äº†ã€‚è¦é‡æ–°è®¡ç®— key çš„å“ˆå¸Œï¼Œæ‰èƒ½å†³å®šå®ƒåˆ°åº•è½åœ¨å“ªä¸ª bucketã€‚ä¾‹å¦‚ï¼ŒåŸæ¥ B = 5ï¼Œè®¡ç®—å‡º key çš„å“ˆå¸Œåï¼Œåªç”¨çœ‹å®ƒçš„ä½ 5 ä½ï¼Œå°±èƒ½å†³å®šå®ƒè½åœ¨å“ªä¸ª bucketã€‚æ‰©å®¹åï¼ŒB å˜æˆäº† 6ï¼Œå› æ­¤éœ€è¦å¤šçœ‹ä¸€ä½ï¼Œå®ƒçš„ä½ 6 ä½å†³å®š key è½åœ¨å“ªä¸ª bucketã€‚è¿™ç§°ä¸º <code>rehash</code>ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57740474-af7adb80-76ea-11e9-8409-4af0ce1a814a.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57740474-af7adb80-76ea-11e9-8409-4af0ce1a814a.png" loading="lazy" alt="map rehash">
	</a>
	
	<figcaption>map rehash</figcaption>
	
</figure><p></p>
<p>å› æ­¤ï¼ŒæŸä¸ª key åœ¨æ¬è¿å‰å bucket åºå·å¯èƒ½å’ŒåŸæ¥ç›¸ç­‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ç›¸æ¯”åŸæ¥åŠ ä¸Š 2^Bï¼ˆåŸæ¥çš„ B å€¼ï¼‰ï¼Œå–å†³äº hash å€¼ ç¬¬ 6 bit ä½æ˜¯ 0 è¿˜æ˜¯ 1ã€‚</p>
<p>ç†è§£äº†ä¸Šé¢ bucket åºå·çš„å˜åŒ–ï¼Œæˆ‘ä»¬å°±å¯ä»¥å›ç­”å¦ä¸€ä¸ªé—®é¢˜äº†ï¼šä¸ºä»€ä¹ˆéå† map æ˜¯æ— åºçš„ï¼Ÿ</p>
<p>map åœ¨æ‰©å®¹åï¼Œä¼šå‘ç”Ÿ key çš„æ¬è¿ï¼ŒåŸæ¥è½åœ¨åŒä¸€ä¸ª bucket ä¸­çš„ keyï¼Œæ¬è¿åï¼Œæœ‰äº› key å°±è¦è¿œèµ°é«˜é£äº†ï¼ˆbucket åºå·åŠ ä¸Šäº† 2^Bï¼‰ã€‚è€Œéå†çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æŒ‰é¡ºåºéå† bucketï¼ŒåŒæ—¶æŒ‰é¡ºåºéå† bucket ä¸­çš„ keyã€‚æ¬è¿åï¼Œkey çš„ä½ç½®å‘ç”Ÿäº†é‡å¤§çš„å˜åŒ–ï¼Œæœ‰äº› key é£ä¸Šé«˜æï¼Œæœ‰äº› key åˆ™åŸåœ°ä¸åŠ¨ã€‚è¿™æ ·ï¼Œéå† map çš„ç»“æœå°±ä¸å¯èƒ½æŒ‰åŸæ¥çš„é¡ºåºäº†ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæˆ‘å°±ä¸€ä¸ª hard code çš„ mapï¼Œæˆ‘ä¹Ÿä¸ä¼šå‘ map è¿›è¡Œæ’å…¥åˆ é™¤çš„æ“ä½œï¼ŒæŒ‰ç†è¯´æ¯æ¬¡éå†è¿™æ ·çš„ map éƒ½ä¼šè¿”å›ä¸€ä¸ªå›ºå®šé¡ºåºçš„ key/value åºåˆ—å§ã€‚çš„ç¡®æ˜¯è¿™æ ·ï¼Œä½†æ˜¯ Go æœç»äº†è¿™ç§åšæ³•ï¼Œå› ä¸ºè¿™æ ·ä¼šç»™æ–°æ‰‹ç¨‹åºå‘˜å¸¦æ¥è¯¯è§£ï¼Œä»¥ä¸ºè¿™æ˜¯ä¸€å®šä¼šå‘ç”Ÿçš„äº‹æƒ…ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé…¿æˆå¤§é”™ã€‚</p>
<p>å½“ç„¶ï¼ŒGo åšå¾—æ›´ç»ï¼Œå½“æˆ‘ä»¬åœ¨éå† map æ—¶ï¼Œå¹¶ä¸æ˜¯å›ºå®šåœ°ä» 0 å· bucket å¼€å§‹éå†ï¼Œæ¯æ¬¡éƒ½æ˜¯ä»ä¸€ä¸ªéšæœºå€¼åºå·çš„ bucket å¼€å§‹éå†ï¼Œå¹¶ä¸”æ˜¯ä»è¿™ä¸ª bucket çš„ä¸€ä¸ªéšæœºåºå·çš„ cell å¼€å§‹éå†ã€‚è¿™æ ·ï¼Œå³ä½¿ä½ æ˜¯ä¸€ä¸ªå†™æ­»çš„ mapï¼Œä»…ä»…åªæ˜¯éå†å®ƒï¼Œä¹Ÿä¸å¤ªå¯èƒ½ä¼šè¿”å›ä¸€ä¸ªå›ºå®šåºåˆ—çš„ key/value å¯¹äº†ã€‚</p>
<p>å¤šè¯´ä¸€å¥ï¼Œâ€œè¿­ä»£ map çš„ç»“æœæ˜¯æ— åºçš„â€ è¿™ä¸ªç‰¹æ€§æ˜¯ä» go 1.0 å¼€å§‹åŠ å…¥çš„ã€‚</p>
<p>å†æ˜ç¡®ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæ‰©å®¹åï¼ŒB å¢åŠ äº† 1ï¼Œæ„å‘³ç€ buckets æ€»æ•°æ˜¯åŸæ¥çš„ 2 å€ï¼ŒåŸæ¥ 1 å·çš„æ¡¶ â€œè£‚å˜â€ åˆ°ä¸¤ä¸ªæ¡¶ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒåŸå§‹ B = 2ï¼Œ1 å· bucket ä¸­æœ‰ 2 ä¸ª key çš„å“ˆå¸Œå€¼ä½ 3 ä½åˆ†åˆ«ä¸ºï¼š010ï¼Œ110ã€‚ç”±äºåŸæ¥ B = 2ï¼Œæ‰€ä»¥ä½ 2 ä½ <code>10</code> å†³å®šå®ƒä»¬è½åœ¨ 2 å·æ¡¶ï¼Œç°åœ¨ B å˜æˆ 3ï¼Œæ‰€ä»¥ <code>010</code>ã€<code>110</code> åˆ†åˆ«è½å…¥ 2ã€6 å·æ¡¶ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57818861-74df7480-77b8-11e9-8104-2a58dc006660.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57818861-74df7480-77b8-11e9-8104-2a58dc006660.png" loading="lazy" alt="bucket split">
	</a>
	
	<figcaption>bucket split</figcaption>
	
</figure><p></p>
<p>ç†è§£äº†è¿™ä¸ªï¼Œåé¢è®² map è¿­ä»£çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p>
<p>å†æ¥è®²æ¬è¿å‡½æ•°ä¸­çš„å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<p>evacuate å‡½æ•°æ¯æ¬¡åªå®Œæˆä¸€ä¸ª bucket çš„æ¬è¿å·¥ä½œï¼Œå› æ­¤è¦éå†å®Œæ­¤ bucket çš„æ‰€æœ‰çš„ cellï¼Œå°†æœ‰å€¼çš„ cell copy åˆ°æ–°çš„åœ°æ–¹ã€‚bucket è¿˜ä¼šé“¾æ¥ overflow bucketï¼Œå®ƒä»¬åŒæ ·éœ€è¦æ¬è¿ã€‚å› æ­¤ä¼šæœ‰ 2 å±‚å¾ªç¯ï¼Œå¤–å±‚éå† bucket å’Œ overflow bucketï¼Œå†…å±‚éå† bucket çš„æ‰€æœ‰ cellã€‚è¿™æ ·çš„å¾ªç¯åœ¨ map çš„æºç é‡Œåˆ°å¤„éƒ½æ˜¯ï¼Œè¦ç†è§£é€äº†ã€‚</p>
<p>æºç é‡Œæåˆ° X, Y partï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬è¯´çš„å¦‚æœæ˜¯æ‰©å®¹åˆ°åŸæ¥çš„ 2 å€ï¼Œæ¡¶çš„æ•°é‡æ˜¯åŸæ¥çš„ 2 å€ï¼Œå‰ä¸€åŠæ¡¶è¢«ç§°ä¸º X partï¼Œåä¸€åŠæ¡¶è¢«ç§°ä¸º Y partã€‚ä¸€ä¸ª bucket ä¸­çš„ key å¯èƒ½ä¼šåˆ†è£‚è½åˆ° 2 ä¸ªæ¡¶ï¼Œä¸€ä¸ªä½äº X partï¼Œä¸€ä¸ªä½äº Y partã€‚æ‰€ä»¥åœ¨æ¬è¿ä¸€ä¸ª cell ä¹‹å‰ï¼Œéœ€è¦çŸ¥é“è¿™ä¸ª cell ä¸­çš„ key æ˜¯è½åˆ°å“ªä¸ª Partã€‚å¾ˆç®€å•ï¼Œé‡æ–°è®¡ç®— cell ä¸­ key çš„ hashï¼Œå¹¶å‘å‰ â€œå¤šçœ‹â€ ä¸€ä½ï¼Œå†³å®šè½å…¥å“ªä¸ª Partï¼Œè¿™ä¸ªå‰é¢ä¹Ÿè¯´å¾—å¾ˆè¯¦ç»†äº†ã€‚</p>
<p>æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µæ˜¯ï¼šæœ‰ä¸€ç§ keyï¼Œæ¯æ¬¡å¯¹å®ƒè®¡ç®— hashï¼Œå¾—åˆ°çš„ç»“æœéƒ½ä¸ä¸€æ ·ã€‚è¿™ä¸ª key å°±æ˜¯ <code>math.NaN()</code> çš„ç»“æœï¼Œå®ƒçš„å«ä¹‰æ˜¯ <code>not a number</code>ï¼Œç±»å‹æ˜¯ float64ã€‚å½“å®ƒä½œä¸º map çš„ keyï¼Œåœ¨æ¬è¿çš„æ—¶å€™ï¼Œä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼šå†æ¬¡è®¡ç®—å®ƒçš„å“ˆå¸Œå€¼å’Œå®ƒå½“åˆæ’å…¥ map æ—¶çš„è®¡ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼ä¸ä¸€æ ·ï¼</p>
<p>ä½ å¯èƒ½æƒ³åˆ°äº†ï¼Œè¿™æ ·å¸¦æ¥çš„ä¸€ä¸ªåæœæ˜¯ï¼Œè¿™ä¸ª key æ˜¯æ°¸è¿œä¸ä¼šè¢« Get æ“ä½œè·å–çš„ï¼å½“æˆ‘ä½¿ç”¨ <code>m[math.NaN()]</code> è¯­å¥çš„æ—¶å€™ï¼Œæ˜¯æŸ¥ä¸å‡ºæ¥ç»“æœçš„ã€‚è¿™ä¸ª key åªæœ‰åœ¨éå†æ•´ä¸ª map çš„æ—¶å€™ï¼Œæ‰æœ‰æœºä¼šç°èº«ã€‚æ‰€ä»¥ï¼Œå¯ä»¥å‘ä¸€ä¸ª map æ’å…¥ä»»æ„æ•°é‡çš„ <code>math.NaN()</code> ä½œä¸º keyã€‚</p>
<p>å½“æ¬è¿ç¢°åˆ° <code>math.NaN()</code> çš„ key æ—¶ï¼Œåªé€šè¿‡ tophash çš„æœ€ä½ä½å†³å®šåˆ†é…åˆ° X part è¿˜æ˜¯ Y partï¼ˆå¦‚æœæ‰©å®¹åæ˜¯åŸæ¥ buckets æ•°é‡çš„ 2 å€ï¼‰ã€‚å¦‚æœ tophash çš„æœ€ä½ä½æ˜¯ 0 ï¼Œåˆ†é…åˆ° X partï¼›å¦‚æœæ˜¯ 1 ï¼Œåˆ™åˆ†é…åˆ° Y partã€‚</p>
<p>è¿™æ˜¯é€šè¿‡ tophash å€¼ä¸æ–°ç®—å‡ºæ¥çš„å“ˆå¸Œå€¼è¿›è¡Œè¿ç®—å¾—åˆ°çš„ï¼š</p>
<pre><code class="language-go">    if top&amp;1 != 0 {
        // top hash æœ€ä½ä½ä¸º 1
        // æ–°ç®—å‡ºæ¥çš„ hash å€¼çš„ B ä½ç½® 1
    	hash |= newbit
    } else {
        // æ–°ç®—å‡ºæ¥çš„ hash å€¼çš„ B ä½ç½® 0
    	hash &amp;^= newbit
    }
    
    // hash å€¼çš„ B ä½ä¸º 0ï¼Œåˆ™æ¬è¿åˆ° x part
    // å½“ B = 5æ—¶ï¼Œnewbit = 32ï¼ŒäºŒè¿›åˆ¶ä½ 6 ä½ä¸º 10 0000
    useX = hash&amp;newbit == 0
</code></pre>
<p>å…¶å®è¿™æ ·çš„ key æˆ‘éšä¾¿æ¬è¿åˆ°å“ªä¸ª bucket éƒ½è¡Œï¼Œå½“ç„¶ï¼Œè¿˜æ˜¯è¦æ¬è¿åˆ°ä¸Šé¢è£‚å˜é‚£å¼ å›¾ä¸­çš„ä¸¤ä¸ª bucket ä¸­å»ã€‚ä½†è¿™æ ·åšæ˜¯æœ‰å¥½å¤„çš„ï¼Œåœ¨åé¢è®² map è¿­ä»£çš„æ—¶å€™ä¼šå†è¯¦ç»†è§£é‡Šï¼Œæš‚æ—¶çŸ¥é“æ˜¯è¿™æ ·åˆ†é…çš„å°±è¡Œã€‚</p>
<p>ç¡®å®šäº†è¦æ¬è¿åˆ°çš„ç›®æ ‡ bucket åï¼Œæ¬è¿æ“ä½œå°±æ¯”è¾ƒå¥½è¿›è¡Œäº†ã€‚å°†æº key/value å€¼ copy åˆ°ç›®çš„åœ°ç›¸åº”çš„ä½ç½®ã€‚</p>
<p>è®¾ç½® key åœ¨åŸå§‹ buckets çš„ tophash ä¸º <code>evacuatedX</code> æˆ–æ˜¯ <code>evacuatedY</code>ï¼Œè¡¨ç¤ºå·²ç»æ¬è¿åˆ°äº†æ–° map çš„ x part æˆ–æ˜¯ y partã€‚æ–° map çš„ tophash åˆ™æ­£å¸¸å– key å“ˆå¸Œå€¼çš„é«˜ 8 ä½ã€‚</p>
<p>ä¸‹é¢é€šè¿‡å›¾æ¥å®è§‚åœ°çœ‹ä¸€ä¸‹æ‰©å®¹å‰åçš„å˜åŒ–ã€‚</p>
<p>æ‰©å®¹å‰ï¼ŒB = 2ï¼Œå…±æœ‰ 4 ä¸ª bucketsï¼Œlowbits è¡¨ç¤º hash å€¼çš„ä½ä½ã€‚å‡è®¾æˆ‘ä»¬ä¸å…³æ³¨å…¶ä»– buckets æƒ…å†µï¼Œä¸“æ³¨åœ¨ 2 å· bucketã€‚å¹¶ä¸”å‡è®¾ overflow å¤ªå¤šï¼Œè§¦å‘äº†ç­‰é‡æ‰©å®¹ï¼ˆå¯¹åº”äºå‰é¢çš„æ¡ä»¶ 2ï¼‰ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57963483-5b286380-7957-11e9-852a-8296c6c16daa.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57963483-5b286380-7957-11e9-852a-8296c6c16daa.png" loading="lazy" alt="æ‰©å®¹å‰">
	</a>
	
	<figcaption>æ‰©å®¹å‰</figcaption>
	
</figure><p></p>
<p>æ‰©å®¹å®Œæˆåï¼Œoverflow bucket æ¶ˆå¤±äº†ï¼Œkey éƒ½é›†ä¸­åˆ°äº†ä¸€ä¸ª bucketï¼Œæ›´ä¸ºç´§å‡‘äº†ï¼Œæé«˜äº†æŸ¥æ‰¾çš„æ•ˆç‡ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57963519-dc7ff600-7957-11e9-9877-36c3f4bc3526.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57963519-dc7ff600-7957-11e9-9877-36c3f4bc3526.png" loading="lazy" alt="same size æ‰©å®¹">
	</a>
	
	<figcaption>same size æ‰©å®¹</figcaption>
	
</figure><p></p>
<p>å‡è®¾è§¦å‘äº† 2 å€çš„æ‰©å®¹ï¼Œé‚£ä¹ˆæ‰©å®¹å®Œæˆåï¼Œè€ buckets ä¸­çš„ key åˆ†è£‚åˆ°äº† 2 ä¸ª æ–°çš„ bucketã€‚ä¸€ä¸ªåœ¨ x partï¼Œä¸€ä¸ªåœ¨ y çš„ partã€‚ä¾æ®æ˜¯ hash çš„ lowbitsã€‚æ–° map ä¸­ <code>0-3</code> ç§°ä¸º x partï¼Œ<code>4-7</code> ç§°ä¸º y partã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57963651-04705900-795a-11e9-9801-e3dc475d4782.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57963651-04705900-795a-11e9-9801-e3dc475d4782.png" loading="lazy" alt="2å€æ‰©å®¹">
	</a>
	
	<figcaption>2 å€æ‰©å®¹</figcaption>
	
</figure><p></p>
<p>æ³¨æ„ï¼Œä¸Šé¢çš„ä¸¤å¼ å›¾å¿½ç•¥äº†å…¶ä»– buckets çš„æ¬è¿æƒ…å†µï¼Œè¡¨ç¤ºæ‰€æœ‰çš„ bucket éƒ½æ¬è¿å®Œæ¯•åçš„æƒ…å½¢ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæ¬è¿æ˜¯ä¸€ä¸ª â€œæ¸è¿›â€ çš„è¿‡ç¨‹ï¼Œå¹¶ä¸ä¼šä¸€ä¸‹å­å°±å…¨éƒ¨æ¬è¿å®Œæ¯•ã€‚æ‰€ä»¥åœ¨æ¬è¿è¿‡ç¨‹ä¸­ï¼Œoldbuckets æŒ‡é’ˆè¿˜ä¼šæŒ‡å‘åŸæ¥è€çš„ []bmapï¼Œå¹¶ä¸”å·²ç»æ¬è¿å®Œæ¯•çš„ key çš„ tophash å€¼ä¼šæ˜¯ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œè¡¨ç¤º key çš„æ¬è¿å»å‘ã€‚</p>
<h2 id="map-çš„éå†">map çš„éå†</h2>
<p>æœ¬æ¥ map çš„éå†è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼šéå†æ‰€æœ‰çš„ bucket ä»¥åŠå®ƒåé¢æŒ‚çš„ overflow bucketï¼Œç„¶åæŒ¨ä¸ªéå† bucket ä¸­çš„æ‰€æœ‰ cellã€‚æ¯ä¸ª bucket ä¸­åŒ…å« 8 ä¸ª cellï¼Œä»æœ‰ key çš„ cell ä¸­å–å‡º key å’Œ valueï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ã€‚</p>
<p>ä½†æ˜¯ï¼Œç°å®å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ã€‚è¿˜è®°å¾—å‰é¢è®²è¿‡çš„æ‰©å®¹è¿‡ç¨‹å—ï¼Ÿæ‰©å®¹è¿‡ç¨‹ä¸æ˜¯ä¸€ä¸ªåŸå­çš„æ“ä½œï¼Œå®ƒæ¯æ¬¡æœ€å¤šåªæ¬è¿ 2 ä¸ª bucketï¼Œæ‰€ä»¥å¦‚æœè§¦å‘äº†æ‰©å®¹æ“ä½œï¼Œé‚£ä¹ˆåœ¨å¾ˆé•¿æ—¶é—´é‡Œï¼Œmap çš„çŠ¶æ€éƒ½æ˜¯å¤„äºä¸€ä¸ªä¸­é—´æ€ï¼šæœ‰äº› bucket å·²ç»æ¬è¿åˆ°æ–°å®¶ï¼Œè€Œæœ‰äº› bucket è¿˜å¾…åœ¨è€åœ°æ–¹ã€‚</p>
<p>å› æ­¤ï¼Œéå†å¦‚æœå‘ç”Ÿåœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œå°±ä¼šæ¶‰åŠåˆ°éå†æ–°è€ bucket çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯éš¾ç‚¹æ‰€åœ¨ã€‚</p>
<p>æˆ‘å…ˆå†™ä¸€ä¸ªç®€å•çš„ä»£ç æ ·ä¾‹ï¼Œå‡è£…ä¸çŸ¥é“éå†è¿‡ç¨‹å…·ä½“è°ƒç”¨çš„æ˜¯ä»€ä¹ˆå‡½æ•°ï¼š</p>
<pre><code class="language-go">    package main
    
    import "fmt"
    
    func main() {
    	ageMp := make(map[string]int)
    	ageMp["qcrao"] = 18
    
    	for name, age := range ageMp {
    		fmt.Println(name, age)
    	}
    }
</code></pre>
<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code class="language-go">    go tool compile -S main.go
</code></pre>
<p>å¾—åˆ°æ±‡ç¼–å‘½ä»¤ã€‚è¿™é‡Œå°±ä¸é€è¡Œè®²è§£äº†ï¼Œå¯ä»¥å»çœ‹ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ï¼Œè¯´å¾—å¾ˆè¯¦ç»†ã€‚</p>
<p>å…³é”®çš„å‡ è¡Œæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    // ......
    0x0124 00292 (test16.go:9)      CALL    runtime.mapiterinit(SB)
    
    // ......
    0x01fb 00507 (test16.go:9)      CALL    runtime.mapiternext(SB)
    0x0200 00512 (test16.go:9)      MOVQ    ""..autotmp_4+160(SP), AX
    0x0208 00520 (test16.go:9)      TESTQ   AX, AX
    0x020b 00523 (test16.go:9)      JNE     302
    
    // ......
</code></pre>
<p>è¿™æ ·ï¼Œå…³äº map è¿­ä»£ï¼Œåº•å±‚çš„å‡½æ•°è°ƒç”¨å…³ç³»ä¸€ç›®äº†ç„¶ã€‚å…ˆæ˜¯è°ƒç”¨ <code>mapiterinit</code> å‡½æ•°åˆå§‹åŒ–è¿­ä»£å™¨ï¼Œç„¶åå¾ªç¯è°ƒç”¨ <code>mapiternext</code> å‡½æ•°è¿›è¡Œ map è¿­ä»£ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57976471-ad2ebf00-7a13-11e9-8dd8-d7be54f96440.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57976471-ad2ebf00-7a13-11e9-8dd8-d7be54f96440.png" loading="lazy" alt="map iter loop">
	</a>
	
	<figcaption>map iter loop</figcaption>
	
</figure><p></p>
<p>è¿­ä»£å™¨çš„ç»“æ„ä½“å®šä¹‰ï¼š</p>
<pre><code class="language-go">    type hiter struct {
    	// key æŒ‡é’ˆ
    	key         unsafe.Pointer
    	// value æŒ‡é’ˆ
    	value       unsafe.Pointer
    	// map ç±»å‹ï¼ŒåŒ…å«å¦‚ key size å¤§å°ç­‰
    	t           *maptype
    	// map header
    	h           *hmap
    	// åˆå§‹åŒ–æ—¶æŒ‡å‘çš„ bucket
    	buckets     unsafe.Pointer
    	// å½“å‰éå†åˆ°çš„ bmap
    	bptr        *bmap
    	overflow    [2]*[]*bmap
    	// èµ·å§‹éå†çš„ bucet ç¼–å·
    	startBucket uintptr
    	// éå†å¼€å§‹æ—¶ cell çš„ç¼–å·ï¼ˆæ¯ä¸ª bucket ä¸­æœ‰ 8 ä¸ª cellï¼‰
    	offset      uint8
    	// æ˜¯å¦ä»å¤´éå†äº†
    	wrapped     bool
    	// B çš„å¤§å°
    	B           uint8
    	// æŒ‡ç¤ºå½“å‰ cell åºå·
    	i           uint8
    	// æŒ‡å‘å½“å‰çš„ bucket
    	bucket      uintptr
    	// å› ä¸ºæ‰©å®¹ï¼Œéœ€è¦æ£€æŸ¥çš„ bucket
    	checkBucket uintptr
    }
</code></pre>
<p><code>mapiterinit</code> å°±æ˜¯å¯¹ hiter ç»“æ„ä½“é‡Œçš„å­—æ®µè¿›è¡Œåˆå§‹åŒ–èµ‹å€¼æ“ä½œã€‚</p>
<p>å‰é¢å·²ç»æåˆ°è¿‡ï¼Œå³ä½¿æ˜¯å¯¹ä¸€ä¸ªå†™æ­»çš„ map è¿›è¡Œéå†ï¼Œæ¯æ¬¡å‡ºæ¥çš„ç»“æœä¹Ÿæ˜¯æ— åºçš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥è¿‘è·ç¦»åœ°è§‚å¯Ÿä»–ä»¬çš„å®ç°äº†ã€‚</p>
<pre><code class="language-go">    // ç”Ÿæˆéšæœºæ•° r
    r := uintptr(fastrand())
    if h.B &gt; 31-bucketCntBits {
    	r += uintptr(fastrand()) &lt;&lt; 31
    }
    
    // ä»å“ªä¸ª bucket å¼€å§‹éå†
    it.startBucket = r &amp; (uintptr(1)&lt;&lt;h.B - 1)
    // ä» bucket çš„å“ªä¸ª cell å¼€å§‹éå†
    it.offset = uint8(r &gt;&gt; h.B &amp; (bucketCnt - 1))
</code></pre>
<p>ä¾‹å¦‚ï¼ŒB = 2ï¼Œé‚£ <code>uintptr(1)&lt;&lt;h.B - 1</code> ç»“æœå°±æ˜¯ 3ï¼Œä½ 8 ä½ä¸º <code>0000 0011</code>ï¼Œå°† r ä¸ä¹‹ç›¸ä¸ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª <code>0~3</code> çš„ bucket åºå·ï¼›bucketCnt - 1 ç­‰äº 7ï¼Œä½ 8 ä½ä¸º <code>0000 0111</code>ï¼Œå°† r å³ç§» 2 ä½åï¼Œä¸ 7 ç›¸ä¸ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª <code>0~7</code> å·çš„ cellã€‚</p>
<p>äºæ˜¯ï¼Œåœ¨ <code>mapiternext</code> å‡½æ•°ä¸­å°±ä¼šä» it.startBucket çš„ it.offset å·çš„ cell å¼€å§‹éå†ï¼Œå–å‡ºå…¶ä¸­çš„ key å’Œ valueï¼Œç›´åˆ°åˆå›åˆ°èµ·ç‚¹ bucketï¼Œå®Œæˆéå†è¿‡ç¨‹ã€‚</p>
<p>æºç éƒ¨åˆ†æ¯”è¾ƒå¥½çœ‹æ‡‚ï¼Œå°¤å…¶æ˜¯ç†è§£äº†å‰é¢æ³¨é‡Šçš„å‡ æ®µä»£ç åï¼Œå†çœ‹è¿™éƒ¨åˆ†ä»£ç å°±æ²¡ä»€ä¹ˆå‹åŠ›äº†ã€‚æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘å°†é€šè¿‡å›¾å½¢åŒ–çš„æ–¹å¼è®²è§£æ•´ä¸ªéå†è¿‡ç¨‹ï¼Œå¸Œæœ›èƒ½å¤Ÿæ¸…æ™°æ˜“æ‡‚ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‹å›¾æ‰€ç¤ºçš„ä¸€ä¸ª mapï¼Œèµ·å§‹æ—¶ B = 1ï¼Œæœ‰ä¸¤ä¸ª bucketï¼Œåæ¥è§¦å‘äº†æ‰©å®¹ï¼ˆè¿™é‡Œä¸è¦æ·±ç©¶æ‰©å®¹æ¡ä»¶ï¼Œåªæ˜¯ä¸€ä¸ªè®¾å®šï¼‰ï¼ŒB å˜æˆ 2ã€‚å¹¶ä¸”ï¼Œ 1 å· bucket ä¸­çš„å†…å®¹æ¬è¿åˆ°äº†æ–°çš„ bucketï¼Œ<code>1 å·</code>è£‚å˜æˆ <code>1 å·</code>å’Œ <code>3 å·</code>ï¼›<code>0 å·</code> bucket æš‚æœªæ¬è¿ã€‚è€çš„ bucket æŒ‚åœ¨åœ¨ <code>*oldbuckets</code> æŒ‡é’ˆä¸Šé¢ï¼Œæ–°çš„ bucket åˆ™æŒ‚åœ¨ <code>*buckets</code> æŒ‡é’ˆä¸Šé¢ã€‚</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57978113-f8a79400-7a38-11e9-8e27-3f3ba4fa557f.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57978113-f8a79400-7a38-11e9-8e27-3f3ba4fa557f.png" loading="lazy" alt="map origin">
	</a>
	
	<figcaption>map origin</figcaption>
	
</figure><p></p>
<p>è¿™æ—¶ï¼Œæˆ‘ä»¬å¯¹æ­¤ map è¿›è¡Œéå†ã€‚å‡è®¾ç»è¿‡åˆå§‹åŒ–åï¼ŒstartBucket = 3ï¼Œoffset = 2ã€‚äºæ˜¯ï¼Œéå†çš„èµ·ç‚¹å°†æ˜¯ 3 å· bucket çš„ 2 å· cellï¼Œä¸‹é¢è¿™å¼ å›¾å°±æ˜¯å¼€å§‹éå†æ—¶çš„çŠ¶æ€ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980268-a4fa7200-7a5b-11e9-9ad1-fb2b64fe3159.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980268-a4fa7200-7a5b-11e9-9ad1-fb2b64fe3159.png" loading="lazy" alt="map init">
	</a>
	
	<figcaption>map init</figcaption>
	
</figure><p></p>
<p>æ ‡çº¢çš„è¡¨ç¤ºèµ·å§‹ä½ç½®ï¼Œbucket éå†é¡ºåºä¸ºï¼š3 -&gt; 0 -&gt; 1 -&gt; 2ã€‚</p>
<p>å› ä¸º 3 å· bucket å¯¹åº”è€çš„ 1 å· bucketï¼Œå› æ­¤å…ˆæ£€æŸ¥è€ 1 å· bucket æ˜¯å¦å·²ç»è¢«æ¬è¿è¿‡ã€‚åˆ¤æ–­æ–¹æ³•å°±æ˜¯ï¼š</p>
<pre><code class="language-go">    func evacuated(b *bmap) bool {
    	h := b.tophash[0]
    	return h &gt; empty &amp;&amp; h &lt; minTopHash
    }
</code></pre>
<p>å¦‚æœ b.tophash[0] çš„å€¼åœ¨æ ‡å¿—å€¼èŒƒå›´å†…ï¼Œå³åœ¨ (0,4) åŒºé—´é‡Œï¼Œè¯´æ˜å·²ç»è¢«æ¬è¿è¿‡äº†ã€‚</p>
<pre><code class="language-go">    empty = 0
    evacuatedEmpty = 1
    evacuatedX = 2
    evacuatedY = 3
    minTopHash = 4
</code></pre>
<p>åœ¨æœ¬ä¾‹ä¸­ï¼Œè€ 1 å· bucket å·²ç»è¢«æ¬è¿è¿‡äº†ã€‚æ‰€ä»¥å®ƒçš„ tophash[0] å€¼åœ¨ (0,4) èŒƒå›´å†…ï¼Œå› æ­¤åªç”¨éå†æ–°çš„ 3 å· bucketã€‚</p>
<p>ä¾æ¬¡éå† 3 å· bucket çš„ cellï¼Œè¿™æ—¶å€™ä¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªéç©ºçš„ keyï¼šå…ƒç´  eã€‚åˆ°è¿™é‡Œï¼Œmapiternext å‡½æ•°è¿”å›ï¼Œè¿™æ—¶æˆ‘ä»¬çš„éå†ç»“æœä»…æœ‰ä¸€ä¸ªå…ƒç´ ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980302-56010c80-7a5c-11e9-8263-c11ddcec2ecc.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980302-56010c80-7a5c-11e9-8263-c11ddcec2ecc.png" loading="lazy" alt="iter res">
	</a>
	
	<figcaption>iter res</figcaption>
	
</figure><p></p>
<p>ç”±äºè¿”å›çš„ key ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šç»§ç»­è°ƒç”¨ mapiternext å‡½æ•°ã€‚</p>
<p>ç»§ç»­ä»ä¸Šæ¬¡éå†åˆ°çš„åœ°æ–¹å¾€åéå†ï¼Œä»æ–° 3 å· overflow bucket ä¸­æ‰¾åˆ°äº†å…ƒç´  f å’Œ å…ƒç´  gã€‚</p>
<p>éå†ç»“æœé›†ä¹Ÿå› æ­¤å£®å¤§ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980349-2d2d4700-7a5d-11e9-819a-a59964f70a7c.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980349-2d2d4700-7a5d-11e9-819a-a59964f70a7c.png" loading="lazy" alt="iter res">
	</a>
	
	<figcaption>iter res</figcaption>
	
</figure><p></p>
<p>æ–° 3 å· bucket éå†å®Œä¹‹åï¼Œå›åˆ°äº†æ–° 0 å· bucketã€‚0 å· bucket å¯¹åº”è€çš„ 0 å· bucketï¼Œç»æ£€æŸ¥ï¼Œè€ 0 å· bucket å¹¶æœªæ¬è¿ï¼Œå› æ­¤å¯¹æ–° 0 å· bucket çš„éå†å°±æ”¹ä¸ºéå†è€ 0 å· bucketã€‚é‚£æ˜¯ä¸æ˜¯æŠŠè€ 0 å· bucket ä¸­çš„æ‰€æœ‰ key éƒ½å–å‡ºæ¥å‘¢ï¼Ÿ</p>
<p>å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œå›å¿†ä¸€ä¸‹ï¼Œè€ 0 å· bucket åœ¨æ¬è¿åå°†è£‚å˜æˆ 2 ä¸ª bucketï¼šæ–° 0 å·ã€æ–° 2 å·ã€‚è€Œæˆ‘ä»¬æ­¤æ—¶æ­£åœ¨éå†çš„åªæ˜¯æ–° 0 å· bucketï¼ˆæ³¨æ„ï¼Œéå†éƒ½æ˜¯éå†çš„ <code>*bucket</code> æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„æ–° bucketsï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªä¼šå–å‡ºè€ 0 å· bucket ä¸­é‚£äº›åœ¨è£‚å˜ä¹‹åï¼Œåˆ†é…åˆ°æ–° 0 å· bucket ä¸­çš„é‚£äº› keyã€‚</p>
<p>å› æ­¤ï¼Œ<code>lowbits == 00</code> çš„å°†è¿›å…¥éå†ç»“æœé›†ï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980449-6fa35380-7a5e-11e9-9dbf-86332ea0e215.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980449-6fa35380-7a5e-11e9-9dbf-86332ea0e215.png" loading="lazy" alt="iter res">
	</a>
	
	<figcaption>iter res</figcaption>
	
</figure><p></p>
<p>å’Œä¹‹å‰çš„æµç¨‹ä¸€æ ·ï¼Œç»§ç»­éå†æ–° 1 å· bucketï¼Œå‘ç°è€ 1 å· bucket å·²ç»æ¬è¿ï¼Œåªç”¨éå†æ–° 1 å· bucket ä¸­ç°æœ‰çš„å…ƒç´ å°±å¯ä»¥äº†ã€‚ç»“æœé›†å˜æˆï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980487-e8a2ab00-7a5e-11e9-8e47-050437a099fc.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980487-e8a2ab00-7a5e-11e9-8e47-050437a099fc.png" loading="lazy" alt="iter res">
	</a>
	
	<figcaption>iter res</figcaption>
	
</figure><p></p>
<p>ç»§ç»­éå†æ–° 2 å· bucketï¼Œå®ƒæ¥è‡ªè€ 0 å· bucketï¼Œå› æ­¤éœ€è¦åœ¨è€ 0 å· bucket ä¸­é‚£äº›ä¼šè£‚å˜åˆ°æ–° 2 å· bucket ä¸­çš„ keyï¼Œä¹Ÿå°±æ˜¯ <code>lowbit == 10</code> çš„é‚£äº› keyã€‚</p>
<p>è¿™æ ·ï¼Œéå†ç»“æœé›†å˜æˆï¼š</p>
<p></p><figure>
	<a href="./ã€golangã€‘map è¯¦è§£_files/57980574-ae85d900-7a5f-11e9-8050-ae314a90ee05.png">
		<img src="./ã€golangã€‘map è¯¦è§£_files/57980574-ae85d900-7a5f-11e9-8050-ae314a90ee05.png" loading="lazy" alt="iter res">
	</a>
	
	<figcaption>iter res</figcaption>
	
</figure><p></p>
<p>æœ€åï¼Œç»§ç»­éå†åˆ°æ–° 3 å· bucket æ—¶ï¼Œå‘ç°æ‰€æœ‰çš„ bucket éƒ½å·²ç»éå†å®Œæ¯•ï¼Œæ•´ä¸ªè¿­ä»£è¿‡ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p>é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¦‚æœç¢°åˆ° key æ˜¯ <code>math.NaN()</code> è¿™ç§çš„ï¼Œå¤„ç†æ–¹å¼ç±»ä¼¼ã€‚æ ¸å¿ƒè¿˜æ˜¯è¦çœ‹å®ƒè¢«åˆ†è£‚åå…·ä½“è½å…¥å“ªä¸ª bucketã€‚åªä¸è¿‡åªç”¨çœ‹å®ƒ top hash çš„æœ€ä½ä½ã€‚å¦‚æœ top hash çš„æœ€ä½ä½æ˜¯ 0 ï¼Œåˆ†é…åˆ° X partï¼›å¦‚æœæ˜¯ 1 ï¼Œåˆ™åˆ†é…åˆ° Y partã€‚æ®æ­¤å†³å®šæ˜¯å¦å–å‡º keyï¼Œæ”¾åˆ°éå†ç»“æœé›†é‡Œã€‚</p>
<p>map éå†çš„æ ¸å¿ƒåœ¨äºç†è§£ 2 å€æ‰©å®¹æ—¶ï¼Œè€ bucket ä¼šåˆ†è£‚åˆ° 2 ä¸ªæ–° bucket ä¸­å»ã€‚è€Œéå†æ“ä½œï¼Œä¼šæŒ‰ç…§æ–° bucket çš„åºå·é¡ºåºè¿›è¡Œï¼Œç¢°åˆ°è€ bucket æœªæ¬è¿çš„æƒ…å†µæ—¶ï¼Œè¦åœ¨è€ bucket ä¸­æ‰¾åˆ°å°†æ¥è¦æ¬è¿åˆ°æ–° bucket æ¥çš„ keyã€‚</p>
<h2 id="map-çš„èµ‹å€¼">map çš„èµ‹å€¼</h2>
<p>é€šè¿‡æ±‡ç¼–è¯­è¨€å¯ä»¥çœ‹åˆ°ï¼Œå‘ map ä¸­æ’å…¥æˆ–è€…ä¿®æ”¹ keyï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ <code>mapassign</code> å‡½æ•°ã€‚</p>
<p>å®é™…ä¸Šæ’å…¥æˆ–ä¿®æ”¹ key çš„è¯­æ³•æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å‰è€…æ“ä½œçš„ key åœ¨ map ä¸­ä¸å­˜åœ¨ï¼Œè€Œåè€…æ“ä½œçš„ key å­˜åœ¨ map ä¸­ã€‚</p>
<p>mapassign æœ‰ä¸€ä¸ªç³»åˆ—çš„å‡½æ•°ï¼Œæ ¹æ® key ç±»å‹çš„ä¸åŒï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶ä¼˜åŒ–ä¸ºç›¸åº”çš„ â€œå¿«é€Ÿå‡½æ•°â€ã€‚</p>
<p>key ç±»å‹</p>
<p>æ’å…¥</p>
<pre><code>uint32

mapassign_fast32(t *maptype, h *hmap, key uint32) unsafe.Pointer

uint64

mapassign_fast64(t *maptype, h *hmap, key uint64) unsafe.Pointer

string

mapassign_faststr(t *maptype, h *hmap, ky string) unsafe.Pointer
</code></pre>
<p>æˆ‘ä»¬åªç”¨ç ”ç©¶æœ€ä¸€èˆ¬çš„èµ‹å€¼å‡½æ•° <code>mapassign</code>ã€‚</p>
<p>æ•´ä½“æ¥çœ‹ï¼Œæµç¨‹éå¸¸å¾—ç®€å•ï¼šå¯¹ key è®¡ç®— hash å€¼ï¼Œæ ¹æ® hash å€¼æŒ‰ç…§ä¹‹å‰çš„æµç¨‹ï¼Œæ‰¾åˆ°è¦èµ‹å€¼çš„ä½ç½®ï¼ˆå¯èƒ½æ˜¯æ’å…¥æ–° keyï¼Œä¹Ÿå¯èƒ½æ˜¯æ›´æ–°è€ keyï¼‰ï¼Œå¯¹ç›¸åº”ä½ç½®è¿›è¡Œèµ‹å€¼ã€‚</p>
<p>æºç å¤§ä½“å’Œä¹‹å‰è®²çš„ç±»ä¼¼ï¼Œæ ¸å¿ƒè¿˜æ˜¯ä¸€ä¸ªåŒå±‚å¾ªç¯ï¼Œå¤–å±‚éå† bucket å’Œå®ƒçš„ overflow bucketï¼Œå†…å±‚éå†æ•´ä¸ª bucket çš„å„ä¸ª cellã€‚é™äºç¯‡å¹…ï¼Œè¿™éƒ¨åˆ†ä»£ç çš„æ³¨é‡Šæˆ‘ä¹Ÿä¸å±•ç¤ºäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»çœ‹ï¼Œä¿è¯ç†è§£äº†è¿™ç¯‡æ–‡ç« å†…å®¹åï¼Œèƒ½å¤Ÿçœ‹æ‡‚ã€‚</p>
<p>æˆ‘è¿™é‡Œä¼šé’ˆå¯¹è¿™ä¸ªè¿‡ç¨‹æå‡ ç‚¹é‡è¦çš„ã€‚</p>
<p>å‡½æ•°é¦–å…ˆä¼šæ£€æŸ¥ map çš„æ ‡å¿—ä½ flagsã€‚å¦‚æœ flags çš„å†™æ ‡å¿—ä½æ­¤æ—¶è¢«ç½® 1 äº†ï¼Œè¯´æ˜æœ‰å…¶ä»–åç¨‹åœ¨æ‰§è¡Œ â€œå†™â€ æ“ä½œï¼Œè¿›è€Œå¯¼è‡´ç¨‹åº panicã€‚è¿™ä¹Ÿè¯´æ˜äº† map å¯¹åç¨‹æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
<p>é€šè¿‡å‰æ–‡æˆ‘ä»¬çŸ¥é“æ‰©å®¹æ˜¯æ¸è¿›å¼çš„ï¼Œå¦‚æœ map å¤„åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œé‚£ä¹ˆå½“ key å®šä½åˆ°äº†æŸä¸ª bucket åï¼Œéœ€è¦ç¡®ä¿è¿™ä¸ª bucket å¯¹åº”çš„è€ bucket å®Œæˆäº†è¿ç§»è¿‡ç¨‹ã€‚å³è€ bucket é‡Œçš„ key éƒ½è¦è¿ç§»åˆ°æ–°çš„ bucket ä¸­æ¥ï¼ˆåˆ†è£‚åˆ° 2 ä¸ªæ–° bucketï¼‰ï¼Œæ‰èƒ½åœ¨æ–°çš„ bucket ä¸­è¿›è¡Œæ’å…¥æˆ–è€…æ›´æ–°çš„æ“ä½œã€‚</p>
<p>ä¸Šé¢è¯´çš„æ“ä½œæ˜¯åœ¨å‡½æ•°é å‰çš„ä½ç½®è¿›è¡Œçš„ï¼Œåªæœ‰è¿›è¡Œå®Œäº†è¿™ä¸ªæ¬è¿æ“ä½œåï¼Œæˆ‘ä»¬æ‰èƒ½æ”¾å¿ƒåœ°åœ¨æ–° bucket é‡Œå®šä½ key è¦å®‰ç½®çš„åœ°å€ï¼Œå†è¿›è¡Œä¹‹åçš„æ“ä½œã€‚</p>
<p>ç°åœ¨åˆ°äº†å®šä½ key åº”è¯¥æ”¾ç½®çš„ä½ç½®äº†ï¼Œæ‰€è°“æ‰¾å‡†è‡ªå·±çš„ä½ç½®å¾ˆé‡è¦ã€‚å‡†å¤‡ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªï¼ˆ<code>inserti</code>ï¼‰æŒ‡å‘ key çš„ hash å€¼åœ¨ tophash æ•°ç»„æ‰€å¤„çš„ä½ç½®ï¼Œå¦ä¸€ä¸ª (<code>insertk</code>) æŒ‡å‘ cell çš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯ key æœ€ç»ˆæ”¾ç½®çš„åœ°å€ï¼‰ï¼Œå½“ç„¶ï¼Œå¯¹åº” value çš„ä½ç½®å°±å¾ˆå®¹æ˜“å®šä½å‡ºæ¥äº†ã€‚è¿™ä¸‰è€…å®é™…ä¸Šéƒ½æ˜¯å…³è”çš„ï¼Œåœ¨ tophash æ•°ç»„ä¸­çš„ç´¢å¼•ä½ç½®å†³å®šäº† key åœ¨æ•´ä¸ª bucket ä¸­çš„ä½ç½®ï¼ˆå…± 8 ä¸ª keyï¼‰ï¼Œè€Œ value çš„ä½ç½®éœ€è¦ â€œè·¨è¿‡â€ 8 ä¸ª key çš„é•¿åº¦ã€‚</p>
<p>åœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­ï¼Œinserti å’Œ insertk åˆ†åˆ«æŒ‡å‘ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç©ºé—²çš„ cellã€‚å¦‚æœä¹‹ååœ¨ map æ²¡æœ‰æ‰¾åˆ° key çš„å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´åŸæ¥ map ä¸­æ²¡æœ‰æ­¤ keyï¼Œè¿™æ„å‘³ç€æ’å…¥æ–° keyã€‚é‚£æœ€ç»ˆ key çš„å®‰ç½®åœ°å€å°±æ˜¯ç¬¬ä¸€æ¬¡å‘ç°çš„ â€œç©ºä½â€ï¼ˆtophash æ˜¯ emptyï¼‰ã€‚</p>
<p>å¦‚æœè¿™ä¸ª bucket çš„ 8 ä¸ª key éƒ½å·²ç»æ”¾ç½®æ»¡äº†ï¼Œé‚£åœ¨è·³å‡ºå¾ªç¯åï¼Œå‘ç° inserti å’Œ insertk éƒ½æ˜¯ç©ºï¼Œè¿™æ—¶å€™éœ€è¦åœ¨ bucket åé¢æŒ‚ä¸Š overflow bucketã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨ overflow bucket åé¢å†æŒ‚ä¸Šä¸€ä¸ª overflow bucketã€‚è¿™å°±è¯´æ˜ï¼Œå¤ªå¤š key hash åˆ°äº†æ­¤ bucketã€‚</p>
<p>åœ¨æ­£å¼å®‰ç½® key ä¹‹å‰ï¼Œè¿˜è¦æ£€æŸ¥ map çš„çŠ¶æ€ï¼Œçœ‹å®ƒæ˜¯å¦éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚å¦‚æœæ»¡è¶³æ‰©å®¹çš„æ¡ä»¶ï¼Œå°±ä¸»åŠ¨è§¦å‘ä¸€æ¬¡æ‰©å®¹æ“ä½œã€‚</p>
<p>è¿™ä¹‹åï¼Œæ•´ä¸ªä¹‹å‰çš„æŸ¥æ‰¾å®šä½ key çš„è¿‡ç¨‹ï¼Œè¿˜å¾—å†é‡æ–°èµ°ä¸€æ¬¡ã€‚å› ä¸ºæ‰©å®¹ä¹‹åï¼Œkey çš„åˆ†å¸ƒéƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<p>æœ€åï¼Œä¼šæ›´æ–° map ç›¸å…³çš„å€¼ï¼Œå¦‚æœæ˜¯æ’å…¥æ–° keyï¼Œmap çš„å…ƒç´ æ•°é‡å­—æ®µ count å€¼ä¼šåŠ  1ï¼›åœ¨å‡½æ•°ä¹‹åˆè®¾ç½®çš„ <code>hashWriting</code> å†™æ ‡å¿—å‡ºä¼šæ¸…é›¶ã€‚</p>
<p>å¦å¤–ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„ç‚¹è¦è¯´ä¸€ä¸‹ã€‚å‰é¢è¯´çš„æ‰¾åˆ° key çš„ä½ç½®ï¼Œè¿›è¡Œèµ‹å€¼æ“ä½œï¼Œå®é™…ä¸Šå¹¶ä¸å‡†ç¡®ã€‚æˆ‘ä»¬çœ‹ <code>mapassign</code> å‡½æ•°çš„åŸå‹å°±çŸ¥é“ï¼Œå‡½æ•°å¹¶æ²¡æœ‰ä¼ å…¥ value å€¼ï¼Œæ‰€ä»¥èµ‹å€¼æ“ä½œæ˜¯ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„å‘¢ï¼Ÿ</p>
<pre><code class="language-go">    func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer
    

ç­”æ¡ˆè¿˜å¾—ä»æ±‡ç¼–è¯­è¨€ä¸­å¯»æ‰¾ã€‚æˆ‘ç›´æ¥æ­æ™“ç­”æ¡ˆï¼Œæœ‰å…´è¶£å¯ä»¥ç§ä¸‹å»ç ”ç©¶ä¸€ä¸‹ã€‚`mapassign` å‡½æ•°è¿”å›çš„æŒ‡é’ˆå°±æ˜¯æŒ‡å‘çš„ key æ‰€å¯¹åº”çš„ value å€¼ä½ç½®ï¼Œæœ‰äº†åœ°å€ï¼Œå°±å¾ˆå¥½æ“ä½œèµ‹å€¼äº†ã€‚

map çš„åˆ é™¤
-------

å†™æ“ä½œåº•å±‚çš„æ‰§è¡Œå‡½æ•°æ˜¯ `mapdelete`ï¼š
```go
    func mapdelete(t *maptype, h *hmap, key unsafe.Pointer) 
</code></pre>
<p>æ ¹æ® key ç±»å‹çš„ä¸åŒï¼Œåˆ é™¤æ“ä½œä¼šè¢«ä¼˜åŒ–æˆæ›´å…·ä½“çš„å‡½æ•°ï¼š</p>
<p>key ç±»å‹</p>
<p>åˆ é™¤</p>
<pre><code>uint32

mapdelete_fast32(t *maptype, h *hmap, key uint32)

uint64

mapdelete_fast64(t *maptype, h *hmap, key uint64)

string

mapdelete_faststr(t *maptype, h *hmap, ky string)
</code></pre>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬åªå…³å¿ƒ <code>mapdelete</code> å‡½æ•°ã€‚å®ƒé¦–å…ˆä¼šæ£€æŸ¥ h.flags æ ‡å¿—ï¼Œå¦‚æœå‘ç°å†™æ ‡ä½æ˜¯ 1ï¼Œç›´æ¥ panicï¼Œå› ä¸ºè¿™è¡¨æ˜æœ‰å…¶ä»–åç¨‹åŒæ—¶åœ¨è¿›è¡Œå†™æ“ä½œã€‚</p>
<p>è®¡ç®— key çš„å“ˆå¸Œï¼Œæ‰¾åˆ°è½å…¥çš„ bucketã€‚æ£€æŸ¥æ­¤ map å¦‚æœæ­£åœ¨æ‰©å®¹çš„è¿‡ç¨‹ä¸­ï¼Œç›´æ¥è§¦å‘ä¸€æ¬¡æ¬è¿æ“ä½œã€‚</p>
<p>åˆ é™¤æ“ä½œåŒæ ·æ˜¯ä¸¤å±‚å¾ªç¯ï¼Œæ ¸å¿ƒè¿˜æ˜¯æ‰¾åˆ° key çš„å…·ä½“ä½ç½®ã€‚å¯»æ‰¾è¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œåœ¨ bucket ä¸­æŒ¨ä¸ª cell å¯»æ‰¾ã€‚</p>
<p>æ‰¾åˆ°å¯¹åº”ä½ç½®åï¼Œå¯¹ key æˆ–è€… value è¿›è¡Œ â€œæ¸…é›¶â€ æ“ä½œï¼š</p>
<pre><code class="language-go">    // å¯¹ key æ¸…é›¶
    if t.indirectkey {
    	*(*unsafe.Pointer)(k) = nil
    } else {
    	typedmemclr(t.key, k)
    }
    
    // å¯¹ value æ¸…é›¶
    if t.indirectvalue {
    	*(*unsafe.Pointer)(v) = nil
    } else {
    	typedmemclr(t.elem, v)
    }
</code></pre>
<p>æœ€åï¼Œå°† count å€¼å‡ 1ï¼Œå°†å¯¹åº”ä½ç½®çš„ tophash å€¼ç½®æˆ <code>Empty</code>ã€‚</p>
<p>è¿™å—æºç åŒæ ·æ¯”è¾ƒç®€å•ï¼Œæ„Ÿå…´èµ·ç›´æ¥å»çœ‹ä»£ç ã€‚</p>
<h2 id="map-è¿›é˜¶">map è¿›é˜¶</h2>
<h2 id="å¯ä»¥è¾¹éå†è¾¹åˆ é™¤å—">å¯ä»¥è¾¹éå†è¾¹åˆ é™¤å—</h2>
<p>map å¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ã€‚åŒæ—¶è¯»å†™ä¸€ä¸ª map æ˜¯æœªå®šä¹‰çš„è¡Œä¸ºï¼Œå¦‚æœè¢«æ£€æµ‹åˆ°ï¼Œä¼šç›´æ¥ panicã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œè¿™å¯ä»¥é€šè¿‡è¯»å†™é”æ¥è§£å†³ï¼š<code>sync.RWMutex</code>ã€‚</p>
<p>è¯»ä¹‹å‰è°ƒç”¨ <code>RLock()</code> å‡½æ•°ï¼Œè¯»å®Œä¹‹åè°ƒç”¨ <code>RUnlock()</code> å‡½æ•°è§£é”ï¼›å†™ä¹‹å‰è°ƒç”¨ <code>Lock()</code> å‡½æ•°ï¼Œå†™å®Œä¹‹åï¼Œè°ƒç”¨ <code>Unlock()</code> è§£é”ã€‚</p>
<p>å¦å¤–ï¼Œ<code>sync.Map</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ mapï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚å®ƒçš„å®ç°åŸç†ï¼Œè¿™æ¬¡å…ˆä¸è¯´äº†ã€‚</p>
<h2 id="key-å¯ä»¥æ˜¯-float-å‹å—">key å¯ä»¥æ˜¯ float å‹å—ï¼Ÿ</h2>
<p>ä»è¯­æ³•ä¸Šçœ‹ï¼Œæ˜¯å¯ä»¥çš„ã€‚Go è¯­è¨€ä¸­åªè¦æ˜¯å¯æ¯”è¾ƒçš„ç±»å‹éƒ½å¯ä»¥ä½œä¸º keyã€‚é™¤å¼€ sliceï¼Œmapï¼Œfunctions è¿™å‡ ç§ç±»å‹ï¼Œå…¶ä»–ç±»å‹éƒ½æ˜¯ OK çš„ã€‚å…·ä½“åŒ…æ‹¬ï¼šå¸ƒå°”å€¼ã€æ•°å­—ã€å­—ç¬¦ä¸²ã€æŒ‡é’ˆã€é€šé“ã€æ¥å£ç±»å‹ã€ç»“æ„ä½“ã€åªåŒ…å«ä¸Šè¿°ç±»å‹çš„æ•°ç»„ã€‚è¿™äº›ç±»å‹çš„å…±åŒç‰¹å¾æ˜¯æ”¯æŒ <code>==</code> å’Œ <code>!=</code> æ“ä½œç¬¦ï¼Œ<code>k1 == k2</code> æ—¶ï¼Œå¯è®¤ä¸º k1 å’Œ k2 æ˜¯åŒä¸€ä¸ª keyã€‚å¦‚æœæ˜¯ç»“æ„ä½“ï¼Œåˆ™éœ€è¦å®ƒä»¬çš„å­—æ®µå€¼éƒ½ç›¸ç­‰ï¼Œæ‰è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ keyã€‚</p>
<p>é¡ºä¾¿è¯´ä¸€å¥ï¼Œä»»ä½•ç±»å‹éƒ½å¯ä»¥ä½œä¸º valueï¼ŒåŒ…æ‹¬ map ç±»å‹ã€‚</p>
<p>æ¥çœ‹ä¸ªä¾‹å­ï¼š</p>
<pre><code class="language-go">    func main() {
    	m := make(map[float64]int)
    	m[1.4] = 1
    	m[2.4] = 2
    	m[math.NaN()] = 3
    	m[math.NaN()] = 3
    
    	for k, v := range m {
    		fmt.Printf("[%v, %d] ", k, v)
    	}
    
    	fmt.Printf("\nk: %v, v: %d\n", math.NaN(), m[math.NaN()])
    	fmt.Printf("k: %v, v: %d\n", 2.400000000001, m[2.400000000001])
    	fmt.Printf("k: %v, v: %d\n", 2.4000000000000000000000001, m[2.4000000000000000000000001])
    
    	fmt.Println(math.NaN() == math.NaN())
    }
</code></pre>
<p>ç¨‹åºçš„è¾“å‡ºï¼š</p>
<pre><code class="language-go">    [2.4, 2] [NaN, 3] [NaN, 3] [1.4, 1] 
    k: NaN, v: 0
    k: 2.400000000001, v: 0
    k: 2.4, v: 2
    false
</code></pre>
<p>ä¾‹å­ä¸­å®šä¹‰äº†ä¸€ä¸ª key ç±»å‹æ˜¯ float å‹çš„ mapï¼Œå¹¶å‘å…¶ä¸­æ’å…¥äº† 4 ä¸ª keyï¼š1.4ï¼Œ 2.4ï¼Œ NANï¼ŒNANã€‚</p>
<p>æ‰“å°çš„æ—¶å€™ä¹Ÿæ‰“å°å‡ºäº† 4 ä¸ª keyï¼Œå¦‚æœä½ çŸ¥é“ NAN != NANï¼Œä¹Ÿå°±ä¸å¥‡æ€ªäº†ã€‚å› ä¸ºä»–ä»¬æ¯”è¾ƒçš„ç»“æœä¸ç›¸ç­‰ï¼Œè‡ªç„¶ï¼Œåœ¨ map çœ‹æ¥å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„ key äº†ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æŸ¥è¯¢äº†å‡ ä¸ª keyï¼Œå‘ç° NAN ä¸å­˜åœ¨ï¼Œ2.400000000001 ä¹Ÿä¸å­˜åœ¨ï¼Œè€Œ 2.4000000000000000000000001 å´å­˜åœ¨ã€‚</p>
<p>æœ‰ç‚¹è¯¡å¼‚ï¼Œä¸æ˜¯å—ï¼Ÿ</p>
<p>æ¥ç€ï¼Œæˆ‘é€šè¿‡æ±‡ç¼–å‘ç°äº†å¦‚ä¸‹çš„äº‹å®ï¼š</p>
<p>å½“ç”¨ float64 ä½œä¸º key çš„æ—¶å€™ï¼Œå…ˆè¦å°†å…¶è½¬æˆ unit64 ç±»å‹ï¼Œå†æ’å…¥ key ä¸­ã€‚</p>
<p>å…·ä½“æ˜¯é€šè¿‡ <code>Float64frombits</code> å‡½æ•°å®Œæˆï¼š</p>
<pre><code class="language-go">    // Float64frombits returns the floating point number corresponding
    // the IEEE 754 binary representation b.
    func Float64frombits(b uint64) float64 { return *(*float64)(unsafe.Pointer(&amp;b)) }
</code></pre>
<p>ä¹Ÿå°±æ˜¯å°†æµ®ç‚¹æ•°è¡¨ç¤ºæˆ IEEE 754 è§„å®šçš„æ ¼å¼ã€‚å¦‚èµ‹å€¼è¯­å¥ï¼š</p>
<pre><code class="language-go">    0x00bd 00189 (test18.go:9)      LEAQ    "".statictmp_0(SB), DX
    0x00c4 00196 (test18.go:9)      MOVQ    DX, 16(SP)
    0x00c9 00201 (test18.go:9)      PCDATA  $0, $2
    0x00c9 00201 (test18.go:9)      CALL    runtime.mapassign(SB)
</code></pre>
<p><code>"".statictmp_0(SB)</code> å˜é‡æ˜¯è¿™æ ·çš„ï¼š</p>
<pre><code class="language-go">    "".statictmp_0 SRODATA size=8
            0x0000 33 33 33 33 33 33 03 40
    "".statictmp_1 SRODATA size=8
            0x0000 ff 3b 33 33 33 33 03 40
    "".statictmp_2 SRODATA size=8
            0x0000 33 33 33 33 33 33 03 40
</code></pre>
<p>æˆ‘ä»¬å†æ¥è¾“å‡ºç‚¹ä¸œè¥¿ï¼š</p>
<pre><code class="language-go">    package main
    
    import (
    	"fmt"
    	"math"
    )
    
    func main() {
    	m := make(map[float64]int)
    	m[2.4] = 2
    
        fmt.Println(math.Float64bits(2.4))
    	fmt.Println(math.Float64bits(2.400000000001))
    	fmt.Println(math.Float64bits(2.4000000000000000000000001))
    }

    4612586738352864255
    4612586738352862003
    4612586738352862003
</code></pre>
<p>è½¬æˆåå…­è¿›åˆ¶ä¸ºï¼š</p>
<pre><code class="language-go">    0x4003333333333333
    0x4003333333333BFF
    0x4003333333333333
</code></pre>
<p>å’Œå‰é¢çš„ <code>"".statictmp_0</code> æ¯”è¾ƒä¸€ä¸‹ï¼Œå¾ˆæ¸…æ™°äº†å§ã€‚<code>2.4</code> å’Œ <code>2.4000000000000000000000001</code> ç»è¿‡ <code>math.Float64bits()</code> å‡½æ•°è½¬æ¢åçš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚è‡ªç„¶ï¼ŒäºŒè€…åœ¨ map çœ‹æ¥ï¼Œå°±æ˜¯åŒä¸€ä¸ª key äº†ã€‚</p>
<p>å†æ¥çœ‹ä¸€ä¸‹ NANï¼ˆnot a numberï¼‰ï¼š</p>
<pre><code class="language-go">    // NaN returns an IEEE 754 ``not-a-number'' value.
    func NaN() float64 { return Float64frombits(uvnan) }
</code></pre>
<p>uvan çš„å®šä¹‰ä¸ºï¼š</p>
<pre><code class="language-go">    uvnan    = 0x7FF8000000000001
</code></pre>
<p>NAN() ç›´æ¥è°ƒç”¨ <code>Float64frombits</code>ï¼Œä¼ å…¥å†™æ­»çš„ const å‹å˜é‡ <code>0x7FF8000000000001</code>ï¼Œå¾—åˆ° NAN å‹å€¼ã€‚æ—¢ç„¶ï¼ŒNAN æ˜¯ä»ä¸€ä¸ªå¸¸é‡è§£æå¾—æ¥çš„ï¼Œä¸ºä»€ä¹ˆæ’å…¥ map æ—¶ï¼Œä¼šè¢«è®¤ä¸ºæ˜¯ä¸åŒçš„ keyï¼Ÿ</p>
<p>è¿™æ˜¯ç”±ç±»å‹çš„å“ˆå¸Œå‡½æ•°å†³å®šçš„ï¼Œä¾‹å¦‚ï¼Œå¯¹äº 64 ä½çš„æµ®ç‚¹æ•°ï¼Œå®ƒçš„å“ˆå¸Œå‡½æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">    func f64hash(p unsafe.Pointer, h uintptr) uintptr {
    	f := *(*float64)(p)
    	switch {
    	case f == 0:
    		return c1 * (c0 ^ h) // +0, -0
    	case f != f:
    		return c1 * (c0 ^ h ^ uintptr(fastrand())) // any kind of NaN
    	default:
    		return memhash(p, h, 8)
    	}
    }
</code></pre>
<p>ç¬¬äºŒä¸ª caseï¼Œ<code>f != f</code> å°±æ˜¯é’ˆå¯¹ <code>NAN</code>ï¼Œè¿™é‡Œä¼šå†åŠ ä¸€ä¸ªéšæœºæ•°ã€‚</p>
<p>è¿™æ ·ï¼Œæ‰€æœ‰çš„è°œé¢˜éƒ½è§£å¼€äº†ã€‚</p>
<p>ç”±äº NAN çš„ç‰¹æ€§ï¼š</p>
<pre><code class="language-go">    NAN != NAN
    hash(NAN) != hash(NAN)
</code></pre>
<p>å› æ­¤å‘ map ä¸­æŸ¥æ‰¾çš„ key ä¸º NAN æ—¶ï¼Œä»€ä¹ˆä¹ŸæŸ¥ä¸åˆ°ï¼›å¦‚æœå‘å…¶ä¸­å¢åŠ äº† 4 æ¬¡ NANï¼Œéå†ä¼šå¾—åˆ° 4 ä¸ª NANã€‚</p>
<p>æœ€åè¯´ç»“è®ºï¼šfloat å‹å¯ä»¥ä½œä¸º keyï¼Œä½†æ˜¯ç”±äºç²¾åº¦çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´ä¸€äº›è¯¡å¼‚çš„é—®é¢˜ï¼Œæ…ç”¨ä¹‹ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>åœ¨å†™ä½œæœ¬æ–‡æ—¶ï¼Œæœ‰äº›é—®é¢˜çœ‹éäº†ä¸­æ–‡ä¸–ç•Œçš„åšå®¢éƒ½æ²¡èƒ½æ‰¾åˆ°è§£ç­”ã€‚å½“ç„¶ï¼Œæºç å¯ä»¥è§£ç­”ä»»ä½•é—®é¢˜ã€‚ä½†æ˜¯ï¼Œä½ ä¸èƒ½ä¸€ä¸‹å­è·³è¿›æºç çš„ç»†èŠ‚ï¼Œä½ å¾—å…ˆæœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†æ‰å¥½ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘å¼€å§‹æœç´¢è‹±æ–‡ç›¸å…³è®²æºç çš„æ–‡ç« ï¼Œæ²¡æœ‰å¤ªå¤šè¿™æ–¹é¢çš„ã€‚ä½†æ˜¯æˆ‘å‘ç°äº†ä¸€ç¯‡è´¨é‡å¾ˆé«˜çš„æ–‡ç« ï¼Œæ”¾åœ¨äº†å‚è€ƒèµ„æ–™ç¬¬ä¸€æ¡ï¼Œå®ƒå¸¦é¢†è¯»è€…ä¸€æ­¥æ­¥ä¼˜åŒ–ï¼Œæœ€ç»ˆå®ç°äº†ä» map ä¸­éšæœºå–å‡ºä¸€ä¸ª keyã€‚æ¨èä½ å»é˜…è¯»ï¼Œéå¸¸ç²¾å½©ã€‚å°¤å…¶æ˜¯ä½ çŸ¥é“äº† map çš„åº•å±‚éå†ã€æ‰©å®¹çš„å…·ä½“è¿‡ç¨‹åæ›´æ˜¯å¦‚æ­¤ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼ŒGo è¯­è¨€ä¸­ï¼Œé€šè¿‡å“ˆå¸ŒæŸ¥æ‰¾è¡¨å®ç° mapï¼Œç”¨é“¾è¡¨æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</p>
<p>é€šè¿‡ key çš„å“ˆå¸Œå€¼å°† key æ•£è½åˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶ä¸­æœ‰ 8 ä¸ª cellã€‚å“ˆå¸Œå€¼çš„ä½ä½å†³å®šæ¡¶åºå·ï¼Œé«˜ä½æ ‡è¯†åŒä¸€ä¸ªæ¡¶ä¸­çš„ä¸åŒ keyã€‚</p>
<p>å½“å‘æ¡¶ä¸­æ·»åŠ äº†å¾ˆå¤š keyï¼Œé€ æˆå…ƒç´ è¿‡å¤šï¼Œæˆ–è€…æº¢å‡ºæ¡¶å¤ªå¤šï¼Œå°±ä¼šè§¦å‘æ‰©å®¹ã€‚æ‰©å®¹åˆ†ä¸ºç­‰é‡æ‰©å®¹å’Œ 2 å€å®¹é‡æ‰©å®¹ã€‚æ‰©å®¹åï¼ŒåŸæ¥ä¸€ä¸ª bucket ä¸­çš„ key ä¸€åˆ†ä¸ºäºŒï¼Œä¼šè¢«é‡æ–°åˆ†é…åˆ°ä¸¤ä¸ªæ¡¶ä¸­ã€‚</p>
<p>æ‰©å®¹è¿‡ç¨‹æ˜¯æ¸è¿›çš„ï¼Œä¸»è¦æ˜¯é˜²æ­¢ä¸€æ¬¡æ‰©å®¹éœ€è¦æ¬è¿çš„ key æ•°é‡è¿‡å¤šï¼Œå¼•å‘æ€§èƒ½é—®é¢˜ã€‚è§¦å‘æ‰©å®¹çš„æ—¶æœºæ˜¯å¢åŠ äº†æ–°å…ƒç´ ï¼Œbucket æ¬è¿çš„æ—¶æœºåˆ™å‘ç”Ÿåœ¨èµ‹å€¼ã€åˆ é™¤æœŸé—´ï¼Œæ¯æ¬¡æœ€å¤šæ¬è¿ä¸¤ä¸ª bucketã€‚</p>
<p>æŸ¥æ‰¾ã€èµ‹å€¼ã€åˆ é™¤çš„ä¸€ä¸ªå¾ˆæ ¸å¿ƒçš„å†…å®¹æ˜¯å¦‚ä½•å®šä½åˆ° key æ‰€åœ¨çš„ä½ç½®ï¼Œéœ€è¦é‡ç‚¹ç†è§£ã€‚ä¸€æ—¦ç†è§£ï¼Œå…³äº map çš„æºç å°±å¯ä»¥çœ‹æ‡‚äº†ã€‚</p>
<p>æœ€åï¼Œå¦‚æœæ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ³è¯·ä½ å¸®æˆ‘åˆ†äº«ä¸€ä¸‹ï¼Œæˆ–è€…ç‚¹ä¸€ä¸‹åœ¨çœ‹ï¼Œè°¢è°¢ï¼</p>
<p>æœ€åçš„æœ€åï¼Œç‚¹å‡»<a class="link" href="https://github.com/qcrao/Go-Questions" target="_blank" rel="noopener">é˜…è¯»åŸæ–‡</a>ï¼Œä½ å¯èƒ½ä¼šå‚ä¸è§è¯ä¸€ä¸ªä»é›¶å¼€å§‹çš„åƒæ˜Ÿé¡¹ç›®ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p>ã€english å¦‚ä½•å®ç°éšæœºå–ä¸€ä¸ª map çš„ keyï¼Œéå¸¸ç²¾å½©ã€‘<a class="link" href="https://lukechampine.com/hackmap.html" target="_blank" rel="noopener">https://lukechampine.com/hackmap.html</a></p>
<p>ã€map çš„ç»´åŸºç™¾ç§‘ã€‘<a class="link" href="https://en.wikipedia.org/wiki/Associative_array" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Associative_array</a></p>
<p>ã€sync.map æºç åˆ†æã€‘<a class="link" href="https://github.com/Chasiny/Blog/blob/master/blog/go/sync.Map%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md" target="_blank" rel="noopener">https://github.com/Chasiny/Blog/blob/master/blog/go/sync.Map æºç åˆ†æ. md</a></p>
<p>ã€å„ç§ map ç›¸å…³æ“ä½œçš„æµç¨‹å›¾ã€‘<a class="link" href="https://www.jianshu.com/p/aa0d4808cbb8" target="_blank" rel="noopener">https://www.jianshu.com/p/aa0d4808cbb8</a></p>
<p>ã€map æºç åˆ†æã€‘<a class="link" href="https://www.twblogs.net/a/5bd78d5d2b71777ac86b541f" target="_blank" rel="noopener">https://www.twblogs.net/a/5bd78d5d2b71777ac86b541f</a></p>
<p>ã€æ›¹å¤§å…³äº map çš„æ–‡ç«  ä¸ç”¨è§£é‡Šã€‘<a class="link" href="https://github.com/cch123/golang-notes/blob/master/map.md" target="_blank" rel="noopener">https://github.com/cch123/golang-notes/blob/master/map.md</a></p>
<p>ã€english æœ‰å›¾ã€‘<a class="link" href="https://www.ardanlabs.com/blog/2013/12/macro-view-of-map-internals-in-go.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2013/12/macro-view-of-map-internals-in-go.html</a></p>
<p>ã€english å¯¹æ¯”äº† java, c++ çš„ map å®ç°ã€‘<a class="link" href="https://dave.cheney.net/2018/05/29/how-the-go-runtime-implements-maps-efficiently-without-generics" target="_blank" rel="noopener">https://dave.cheney.net/2018/05/29/how-the-go-runtime-implements-maps-efficiently-without-generics</a></p>
<p>ã€english ä¸ºä»€ä¹ˆ go map å¯¹ç«äº‰æ•æ„Ÿã€‘<a class="link" href="https://dave.cheney.net/2015/12/07/are-go-maps-sensitive-to-data-races" target="_blank" rel="noopener">https://dave.cheney.net/2015/12/07/are-go-maps-sensitive-to-data-races</a></p>
<p>ã€golang blog mapã€‘<a class="link" href="https://blog.golang.org/go-maps-in-action" target="_blank" rel="noopener">https://blog.golang.org/go-maps-in-action</a></p>
<p>ã€randommap å¼€æºä»£ç ã€‘<a class="link" href="https://github.com/lukechampine/randmap" target="_blank" rel="noopener">https://github.com/lukechampine/randmap</a></p>
<p>ã€å›¾ä¸é”™ã€‘<a class="link" href="https://hacpai.com/article/1533916370874" target="_blank" rel="noopener">https://hacpai.com/article/1533916370874</a></p>
<p>ã€å¤œè¯» issueã€‘<a class="link" href="https://github.com/developer-learning/reading-go/issues/332" target="_blank" rel="noopener">https://github.com/developer-learning/reading-go/issues/332</a></p>
<p>ã€æ–°å‘ç°çš„åšå®¢ï¼Œå¾ˆæœ‰æ·±åº¦ã€‘<a class="link" href="https://draveness.me/golang-hashmap" target="_blank" rel="noopener">https://draveness.me/golang-hashmap</a></p>
<p>ã€æ‰©å®¹è¿‡ç¨‹ + å›¾ã€‘<a class="link" href="https://my.oschina.net/renhc/blog/2208417" target="_blank" rel="noopener">https://my.oschina.net/renhc/blog/2208417</a></p>
<p>ã€è¿ç®—ç¬¦ã€‘<a class="link" href="https://juejin.im/post/5c0e572fe51d4522ad6e59d5" target="_blank" rel="noopener">https://juejin.im/post/5c0e572fe51d4522ad6e59d5</a></p>
<p>ã€englishã€‘<a class="link" href="https://www.digitalocean.com/community/tutorials/understanding-maps-in-go" target="_blank" rel="noopener">https://www.digitalocean.com/community/tutorials/understanding-maps-in-go</a></p>
<p>ã€map éå† æºç ç®€å•é˜è¿°ã€‘<a class="link" href="https://gocn.vip/article/1704" target="_blank" rel="noopener">https://gocn.vip/article/1704</a></p>
<p>ã€çŸ­æ–‡ï¼ŒåŒæ—¶éå†ã€åˆ é™¤ key æ˜¯å¯ä»¥çš„ã€‘<a class="link" href="https://cloud.tencent.com/developer/article/1065474" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1065474</a></p>
<p>ã€é¢å‘ä¿¡ä»°ç¼–ç¨‹ï¼Œgolang rangeã€‘<a class="link" href="https://draveness.me/golang-for-range" target="_blank" rel="noopener">https://draveness.me/golang-for-range</a></p>
<p>ã€slice å’Œ map ä½œä¸ºå‚æ•°çš„åŒºåˆ«ã€‘<a class="link" href="https://stackoverflow.com/questions/47590444/slice-vs-map-to-be-used-in-parameter/47590531#47590531" target="_blank" rel="noopener">https://stackoverflow.com/questions/47590444/slice-vs-map-to-be-used-in-parameter/47590531#47590531</a></p>
<p>ã€Go å®˜æ–¹åšå®¢å…³äº mapã€‘<a class="link" href="https://blog.golang.org/go-maps-in-action" target="_blank" rel="noopener">https://blog.golang.org/go-maps-in-action</a></p>
<p>ã€Go è¯­è¨€å¯æ¯”è¾ƒç±»å‹ã€‘<a class="link" href="https://golang.org/ref/spec#Comparison_operators" target="_blank" rel="noopener">https://golang.org/ref/spec#Comparison_operators</a></p>
<p>ã€key ç±»å‹ã€‘<a class="link" href="http://lanlingzi.cn/post/technical/2016/0904_go_map/" target="_blank" rel="noopener">http://lanlingzi.cn/post/technical/2016/0904_go_map/</a></p>
<p>ã€å“ˆå¸Œå‡½æ•°æ€§èƒ½æ¯”è¾ƒã€‘<a class="link" href="http://aras-p.info/blog/2016/08/09/More-Hash-Function-Tests/" target="_blank" rel="noopener">http://aras-p.info/blog/2016/08/09/More-Hash-Function-Tests/</a></p>
<p>ã€å“ˆå¸Œå‡½æ•°é€‰æ‹©ï¼ŒC++/Java å¯¹æ¯”ã€‘<a class="link" href="https://studygolang.com/articles/15839" target="_blank" rel="noopener">https://studygolang.com/articles/15839</a></p>
<p>ã€slice å’Œ map ä½œä¸ºå‡½æ•°å‚æ•°ã€‘<a class="link" href="https://stackoverflow.com/questions/47590444/slice-vs-map-to-be-used-in-parameter/47590531#47590531" target="_blank" rel="noopener">https://stackoverflow.com/questions/47590444/slice-vs-map-to-be-used-in-parameter/47590531#47590531</a></p>
<p>ã€ç…é±¼å¤§ä½¬åšå®¢ map1ã€‘<a class="link" href="https://github.com/EDDYCJY/blog/blob/master/golang/pkg/2019-03-04-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Go-map-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E8%AE%BF%E9%97%AE%E5%85%83%E7%B4%A0.md" target="_blank" rel="noopener">https://github.com/EDDYCJY/blog/blob/master/golang/pkg/2019-03-04 - æ·±å…¥ç†è§£ Go-map - åˆå§‹åŒ–å’Œè®¿é—®å…ƒç´ . md</a></p>
<p>ã€ç…é±¼å¤§ä½¬åšå®¢ map2ã€‘<a class="link" href="https://github.com/EDDYCJY/blog/blob/master/golang/pkg/2019-03-24-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Go-map-%E8%B5%8B%E5%80%BC%E5%92%8C%E6%89%A9%E5%AE%B9%E8%BF%81%E7%A7%BB.md" target="_blank" rel="noopener">https://github.com/EDDYCJY/blog/blob/master/golang/pkg/2019-03-24 - æ·±å…¥ç†è§£ Go-map - èµ‹å€¼å’Œæ‰©å®¹è¿ç§». md</a></p>
<p>ã€å“ˆå¸Œå‡½æ•°çš„å®šä¹‰ã€‘<a class="link" href="http://zhangshuai.ren/2018/05/16/%E6%95%A3%E5%88%97%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0Go%E8%AF%AD%E8%A8%80Map%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">http://zhangshuai.ren/2018/05/16 / æ•£åˆ—ç®—æ³•å®ç° Go è¯­è¨€ Map å‡½æ•° /</a></p>
<p>ã€å¦‚ä½•æ¯”è¾ƒä¸¤ä¸ª map ç›¸ç­‰ã€‘<a class="link" href="https://golangbot.com/maps/" target="_blank" rel="noopener">https://golangbot.com/maps/</a></p>
<p>ã€NAN hashã€‘<a class="link" href="https://research.swtch.com/randhash" target="_blank" rel="noopener">https://research.swtch.com/randhash</a></p>
<p>ã€å¹¶å‘å®‰å…¨é˜è¿°ã€‘<a class="link" href="http://zjykzk.github.io/post/cs/golang/map/" target="_blank" rel="noopener">http://zjykzk.github.io/post/cs/golang/map/</a></p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="https://www.ququ123.top/2024/03/ququ-blog/">
        
        
            <div class="article-image">
                
                    <img src="./ã€golangã€‘map è¯¦è§£_files/cover_huc22343089de730f0d2df13b87c6ac902_47227_800x0_resize_box_3.png" loading="lazy" data-key="ququ-blog" data-hash="http://img.ququ123.top/img/cover_huc22343089de730f0d2df13b87c6ac902_47227_800x0_resize_box_3.png">
                
            </div>
        

        <div class="article-details" style="background: linear-gradient(0deg, rgba(96, 66, 45, 0.5) 0%, rgba(241, 204, 23, 0.75) 100%);">
            <h2 class="article-title">åšå®¢å¯¼èˆª</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="https://www.ququ123.top/2024/03/golang-netpoller/">
        
        
            <div class="article-image">
                
                    <img src="./ã€golangã€‘map è¯¦è§£_files/netpoller-goroutines-scheduling.png" loading="lazy" data-key="golang-netpoller" data-hash="https://img.ququ123.top/img/netpoller-goroutines-scheduling.png">
                
            </div>
        

        <div class="article-details" style="background: linear-gradient(0deg, rgba(92, 100, 116, 0.5) 0%, rgba(240, 162, 102, 0.75) 100%);">
            <h2 class="article-title">ã€golangã€‘netpoller è¯¦è§£</h2>
        </div>
    </a>
</article>
                
                    
<article class="has-image">
    <a href="https://www.ququ123.top/2024/03/golang-pipe/">
        
        
            <div class="article-image">
                
                    <img src="./ã€golangã€‘map è¯¦è§£_files/go-pipe.png" loading="lazy" data-key="golang-pipe" data-hash="https://img.ququ123.top/img/go-pipe.png">
                
            </div>
        

        <div class="article-details" style="background: linear-gradient(0deg, rgba(60, 68, 76, 0.5) 0%, rgba(177, 78, 111, 0.75) 100%);">
            <h2 class="article-title">ã€golangã€‘pipe è¯¦è§£</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
     
        
    
  
  <link rel="stylesheet" href="./ã€golangã€‘map è¯¦è§£_files/waline.css">
  


  
  <div id="waline" data-v-app=""><div data-waline=""><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text"></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email"></div><div class="wl-header-item"><label for="wl-link">ç½‘å€</label><input id="wl-link" class="wl-input wl-link" name="link" type="text"></div></div><textarea id="wl-edit" class="wl-editor" placeholder="æ¬¢è¿è¯„è®º"></textarea><div class="wl-preview" style="display: none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style=""><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z" style="transform: translateY(0.5px);"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if--> &nbsp;å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter">æäº¤</button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animatetransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animatetransform></circle></svg></div></div><div class="wl-emoji-popup"><div class="wl-tab-wrapper"><button type="button" title="weibo_smile"><!--v-if--></button><button type="button" title="weibo_lovely"><!--v-if--></button><button type="button" title="weibo_blush"><!--v-if--></button><button type="button" title="weibo_grin"><!--v-if--></button><button type="button" title="weibo_laugh"><!--v-if--></button><button type="button" title="weibo_joy"><!--v-if--></button><button type="button" title="weibo_angry"><!--v-if--></button><button type="button" title="weibo_bye"><!--v-if--></button><button type="button" title="weibo_hammer"><!--v-if--></button><button type="button" title="weibo_kiss"><!--v-if--></button><button type="button" title="weibo_love"><!--v-if--></button><button type="button" title="weibo_mask"><!--v-if--></button><button type="button" title="weibo_money"><!--v-if--></button><button type="button" title="weibo_quiet"><!--v-if--></button><button type="button" title="weibo_rage"><!--v-if--></button><button type="button" title="weibo_sad"><!--v-if--></button><button type="button" title="weibo_shy"><!--v-if--></button><button type="button" title="weibo_sick"><!--v-if--></button><button type="button" title="weibo_slient"><!--v-if--></button><button type="button" title="weibo_smirk"><!--v-if--></button><button type="button" title="weibo_slap"><!--v-if--></button><button type="button" title="weibo_antic"><!--v-if--></button><button type="button" title="weibo_desire"><!--v-if--></button><button type="button" title="weibo_longing"><!--v-if--></button><button type="button" title="weibo_no_idea"><!--v-if--></button><button type="button" title="weibo_look_down"><!--v-if--></button><button type="button" title="weibo_clap"><!--v-if--></button><button type="button" title="weibo_yum"><!--v-if--></button><button type="button" title="weibo_sleep"><!--v-if--></button><button type="button" title="weibo_dizzy_face"><!--v-if--></button><button type="button" title="weibo_chuckle"><!--v-if--></button><button type="button" title="weibo_disappointed"><!--v-if--></button><button type="button" title="weibo_flushed"><!--v-if--></button><button type="button" title="weibo_heart_eyes"><!--v-if--></button><button type="button" title="weibo_no"><!--v-if--></button><button type="button" title="weibo_shuai"><!--v-if--></button><button type="button" title="weibo_suprised"><!--v-if--></button><button type="button" title="weibo_think"><!--v-if--></button><button type="button" title="weibo_vomit"><!--v-if--></button><button type="button" title="weibo_scream"><!--v-if--></button><button type="button" title="weibo_sleepy"><!--v-if--></button><button type="button" title="weibo_sob"><!--v-if--></button><button type="button" title="weibo_sunglasses"><!--v-if--></button><button type="button" title="weibo_greddy"><!--v-if--></button><button type="button" title="weibo_pick_nose"><!--v-if--></button><button type="button" title="weibo_annoyed"><!--v-if--></button><button type="button" title="weibo_awkward"><!--v-if--></button><button type="button" title="weibo_confused"><!--v-if--></button><button type="button" title="weibo_grievance"><!--v-if--></button><button type="button" title="weibo_poor"><!--v-if--></button><button type="button" title="weibo_wink"><!--v-if--></button><button type="button" title="weibo_rolling_eyes"><!--v-if--></button><button type="button" title="weibo_watermalon"><!--v-if--></button><button type="button" title="weibo_annoyed_left"><!--v-if--></button><button type="button" title="weibo_annoyed_right"><!--v-if--></button><button type="button" title="weibo_yawn"><!--v-if--></button><button type="button" title="weibo_hufen"><!--v-if--></button><button type="button" title="weibo_doge"><!--v-if--></button><button type="button" title="weibo_husky"><!--v-if--></button><button type="button" title="weibo_dog_annoyed"><!--v-if--></button><button type="button" title="weibo_dog_bye"><!--v-if--></button><button type="button" title="weibo_dog_consider"><!--v-if--></button><button type="button" title="weibo_dog_cry"><!--v-if--></button><button type="button" title="weibo_dog_joy"><!--v-if--></button><button type="button" title="weibo_dog_laugh"><!--v-if--></button><button type="button" title="weibo_dog_sweat"><!--v-if--></button><button type="button" title="weibo_dog_think"><!--v-if--></button><button type="button" title="weibo_dog_yum"><!--v-if--></button><button type="button" title="weibo_cat"><!--v-if--></button><button type="button" title="weibo_cat_annoyed"><!--v-if--></button><button type="button" title="weibo_cat_bye"><!--v-if--></button><button type="button" title="weibo_cat_cry"><!--v-if--></button><button type="button" title="weibo_cat_think"><!--v-if--></button><button type="button" title="weibo_girl_annoyed"><!--v-if--></button><button type="button" title="weibo_boy"><!--v-if--></button><button type="button" title="weibo_girl"><!--v-if--></button><button type="button" title="weibo_panda"><!--v-if--></button><button type="button" title="weibo_pig"><!--v-if--></button><button type="button" title="weibo_rabbit"><!--v-if--></button><button type="button" title="weibo_ultraman"><!--v-if--></button><button type="button" title="weibo_wool_group"><!--v-if--></button><button type="button" title="weibo_yan"><!--v-if--></button><button type="button" title="weibo_xi"><!--v-if--></button><button type="button" title="weibo_soap"><!--v-if--></button><button type="button" title="weibo_meng"><!--v-if--></button><button type="button" title="weibo_jiong"><!--v-if--></button><button type="button" title="weibo_geili"><!--v-if--></button><button type="button" title="weibo_shenma"><!--v-if--></button><button type="button" title="weibo_alpaca"><!--v-if--></button></div><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li></ul></div><div class="wl-cards"></div><div class="wl-operation"><button type="button" class="wl-btn">åˆ·æ–°</button></div><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v3.0.0-alpha.2</div></div></div>
  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@3.0.0-alpha.2/dist/waline.mjs';

    init({
      el: '#waline',
      serverURL: 'https://comment.ququ123.top',
    });
  </script>



    

    <footer class="site-footer">
  


    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


<script>
(function(u, c) {
  var d = document, t = 'script', o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
  o.src = u;
  if (c) { o.addEventListener('load', function(e) { c(e); }); }
  s.parentNode.insertBefore(o, s);
})('//cdn.bootcss.com/pangu/3.3.0/pangu.min.js', function() {
  pangu.spacingPage();
});
</script>


  Â© 
  
      2020 - 
  
  2024 
<a href="https://www.ququ123.top/">&nbsp;&nbsp;&nbsp;å»å»çš„åšå®¢</a>
  <br>
        è¿è¡Œ: <a id="days">755</a> å¤©&nbsp;&nbsp;&nbsp;
        ä¹¦å†™: 562.6k å­—  &nbsp;&nbsp;&nbsp;
        69 ç¯‡æ–‡ç« 
  <br> 

  æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv">984</span> &nbsp;&nbsp;&nbsp;
  æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv">8723</span> &nbsp;&nbsp;&nbsp;
<section class="powerby">
  <br>
    <section class="BeiAn-info">
å¤‡æ¡ˆå·ï¼š
  <a target="_blank" href="http://beian.miit.gov.cn/" style="color:#0000ff" rel="nofollow">èµ£ ICP å¤‡ 2022002813 å· - 2</a> | 
  

    </section>
</section>

<script>
var s1 = '2022-04-12';
s1 = new Date(s1.replace(/-/g, "/"));
s2 = new Date();
var days = s2.getTime() - s1.getTime();
var number_of_days = parseInt(days / (1000 * 60 * 60 * 24));
document.getElementById('days').innerHTML = number_of_days;
</script>



</footer>



    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script src="./ã€golangã€‘map è¯¦è§£_files/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer="">
            </script><script src="./ã€golangã€‘map è¯¦è§£_files/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer="">
            </script><link rel="stylesheet" href="./ã€golangã€‘map è¯¦è§£_files/default-skin.css" integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin="anonymous"><link rel="stylesheet" href="./ã€golangã€‘map è¯¦è§£_files/photoswipe.css" integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin="anonymous">

            </main>
    
    
    
    <aside class="sidebar right-sidebar sticky">
        
            <form action="https://www.ququ123.top/search/" class="search-form widget">
        <p>
            <label>æœç´¢</label>
            <input name="keyword" required="" placeholder="è¾“å…¥å…³é”®è¯...">
        
            <button title="æœç´¢">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <circle cx="10" cy="10" r="7"></circle>
  <line x1="21" y1="21" x2="15" y2="15"></line>
</svg>



            </button>
        </p>
    </form>
        
            
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <line x1="5" y1="9" x2="19" y2="9"></line>
  <line x1="5" y1="15" x2="19" y2="15"></line>
  <line x1="11" y1="4" x2="7" y2="20"></line>
  <line x1="17" y1="4" x2="13" y2="20"></line>
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E4%BB%80%E4%B9%88%E6%98%AF-map">ä»€ä¹ˆæ˜¯ map</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-map">ä¸ºä»€ä¹ˆè¦ç”¨ map</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E7%9A%84%E5%BA%95%E5%B1%82%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0">map çš„åº•å±‚å¦‚ä½•å®ç°</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B">map å†…å­˜æ¨¡å‹</a></li>
    <li class="active-class"><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E5%88%9B%E5%BB%BA-map">åˆ›å»º map</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0">å“ˆå¸Œå‡½æ•°</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#key-%E5%AE%9A%E4%BD%8D%E8%BF%87%E7%A8%8B">key å®šä½è¿‡ç¨‹</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E7%9A%84%E4%B8%A4%E7%A7%8D-get-%E6%93%8D%E4%BD%9C">map çš„ä¸¤ç§ get æ“ä½œ</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%AE%B9">å¦‚ä½•è¿›è¡Œæ‰©å®¹</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E7%9A%84%E9%81%8D%E5%8E%86">map çš„éå†</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E7%9A%84%E8%B5%8B%E5%80%BC">map çš„èµ‹å€¼</a></li>
    <li><a href="https://www.ququ123.top/2022/04/golang_map_principle/#map-%E8%BF%9B%E9%98%B6">map è¿›é˜¶</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E5%8F%AF%E4%BB%A5%E8%BE%B9%E9%81%8D%E5%8E%86%E8%BE%B9%E5%88%A0%E9%99%A4%E5%90%97">å¯ä»¥è¾¹éå†è¾¹åˆ é™¤å—</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#key-%E5%8F%AF%E4%BB%A5%E6%98%AF-float-%E5%9E%8B%E5%90%97">key å¯ä»¥æ˜¯ float å‹å—ï¼Ÿ</a></li>
    <li><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
    <li class=""><a href="https://www.ququ123.top/2022/04/golang_map_principle/#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">å‚è€ƒèµ„æ–™</a></li>
  </ol>
</nav>
        </div>
    </section>

        
            <section class="widget categories">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <path d="M9.828 9.172a4 4 0 1 0 0 5.656 a10 10 0 0 0 2.172 -2.828a10 10 0 0 1 2.172 -2.828 a4 4 0 1 1 0 5.656a10 10 0 0 1 -2.172 -2.828a10 10 0 0 0 -2.172 -2.828"></path>
</svg>


  
        </div> 
        <h2 class="widget-title section-title">Categories</h2>
    <div class="widget-categories--list">
<div class="widget">
    <h3 class="widget-title"> </h3>
    <div class="widget-body">
        <div class="category-list">
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/dict/" class="category-list-link">dict<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/golang/" class="category-list-link">golang<span class="category-list-count">21</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/homeassistant/" class="category-list-link">homeassistant<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/http/" class="category-list-link">http<span class="category-list-count">2</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/hugo/" class="category-list-link">hugo<span class="category-list-count">2</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/intset/" class="category-list-link">intset<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/io/" class="category-list-link">io<span class="category-list-count">2</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/k3s/" class="category-list-link">k3s<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/k3sup/" class="category-list-link">k3sup<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/k8s/" class="category-list-link">k8s<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/katex/" class="category-list-link">katex<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/linux/" class="category-list-link">linux<span class="category-list-count">2</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/mysql/" class="category-list-link">mysql<span class="category-list-count">3</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/netpoller/" class="category-list-link">netpoller<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/pipe/" class="category-list-link">pipe<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/quicklist/" class="category-list-link">quicklist<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/raft/" class="category-list-link">raft<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/redis/" class="category-list-link">redis<span class="category-list-count">10</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/robj/" class="category-list-link">robj<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/sds/" class="category-list-link">sds<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/skiplist/" class="category-list-link">skiplist<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/tcp/" class="category-list-link">tcp<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/type/" class="category-list-link">type<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/wireguard/" class="category-list-link">wireguard<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/zero-copy/" class="category-list-link">zero-copy<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/zero_copy/" class="category-list-link">zero_copy<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/ziplist/" class="category-list-link">ziplist<span class="category-list-count">1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" class="category-list-link">åˆ†å¸ƒå¼<span class="category-list-count"> 1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E5%8D%97%E7%93%9C%E4%B9%A6/" class="category-list-link">å—ç“œä¹¦<span class="category-list-count"> 17</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E5%8E%9F%E7%90%86/" class="category-list-link">åŸç†<span class="category-list-count"> 7</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E5%90%B4%E6%81%A9%E8%BE%BE/" class="category-list-link">å´æ©è¾¾<span class="category-list-count"> 10</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E5%B0%8F%E7%B1%B3/" class="category-list-link">å°ç±³<span class="category-list-count"> 1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E6%94%AF%E4%BB%98/" class="category-list-link">æ”¯ä»˜<span class="category-list-count"> 1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" class="category-list-link">æ•°æ®ç»“æ„<span class="category-list-count"> 7</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="category-list-link">æœºå™¨å­¦ä¹ <span class="category-list-count"> 27</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E7%BD%91%E7%BB%9C/" class="category-list-link">ç½‘ç»œ<span class="category-list-count"> 1</span></a>
            </div>
            <div class="category-list-item"><a href="http://www.ququ123.top/categories/%E9%9D%A2%E8%AF%95/" class="category-list-link">é¢è¯•<span class="category-list-count"> 1</span></a>
            </div>
        </div>
    </div>
</div>
    </div>
    </section>
        
            <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <path d="M9.828 9.172a4 4 0 1 0 0 5.656 a10 10 0 0 0 2.172 -2.828a10 10 0 0 1 2.172 -2.828 a4 4 0 1 1 0 5.656a10 10 0 0 1 -2.172 -2.828a10 10 0 0 0 -2.172 -2.828"></path>
</svg>



        </div>
        <h2 class="widget-title section-title">å½’æ¡£</h2>

        
        
        
        
        
        <div class="widget-archive--list">
            <div class="archives-year">
                    <a href="https://www.ququ123.top/archives/#2024">
                        
                            <span class="year">2024</span>
                            <span class="count">16</span>
                        
                    </a> 
                </div>
            <div class="archives-year">
                    <a href="https://www.ququ123.top/archives/#2023">
                        
                            <span class="year">2023</span>
                            <span class="count">31</span>
                        
                    </a> 
                </div>
            <div class="archives-year">
                    <a href="https://www.ququ123.top/archives/#2022">
                        
                            <span class="year">2022</span>
                            <span class="count">22</span>
                        
                    </a> 
                </div>
            
        </div>
    </section>
        
            <section class="widget tagCloud">
    <div class="widget-icon">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"></path>
  <path d="M11 3L20 12a1.5 1.5 0 0 1 0 2L14 20a1.5 1.5 0 0 1 -2 0L3 11v-4a4 4 0 0 1 4 -4h4"></path>
  <circle cx="9" cy="9" r="2"></circle>
</svg>



    </div>
    <h2 class="widget-title section-title">æ ‡ç­¾äº‘</h2>

    <div class="tagCloud-tags">
        
    </div>
</section>
        
    </aside>


        </div>
        <script src="./ã€golangã€‘map è¯¦è§£_files/vibrant.min.js" integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous">
            </script><script type="text/javascript" src="./ã€golangã€‘map è¯¦è§£_files/main.js" defer=""></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    

<div id="waifu-toggle">
            <span>çœ‹æ¿å¨˜</span>
        </div><div id="waifu" style="bottom: 0px;">
            <div id="waifu-tips" class="">æ¬¢è¿é˜…è¯»<span>ã€Œã€golangã€‘map è¯¦è§£ã€</span></div>
            <canvas id="live2d" width="800" height="800"></canvas>
            <div id="waifu-tool"><span id="waifu-tool-hitokoto"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M512 240c0 114.9-114.6 208-256 208c-37.1 0-72.3-6.4-104.1-17.9c-11.9 8.7-31.3 20.6-54.3 30.6C73.6 471.1 44.7 480 16 480c-6.5 0-12.3-3.9-14.8-9.9c-2.5-6-1.1-12.8 3.4-17.4l0 0 0 0 0 0 0 0 .3-.3c.3-.3 .7-.7 1.3-1.4c1.1-1.2 2.8-3.1 4.9-5.7c4.1-5 9.6-12.4 15.2-21.6c10-16.6 19.5-38.4 21.4-62.9C17.7 326.8 0 285.1 0 240C0 125.1 114.6 32 256 32s256 93.1 256 208z"></path></svg></span><span id="waifu-tool-asteroids"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L277.3 424.9l-40.1 74.5c-5.2 9.7-16.3 14.6-27 11.9S192 499 192 488V392c0-5.3 1.8-10.5 5.1-14.7L362.4 164.7c2.5-7.1-6.5-14.3-13-8.4L170.4 318.2l-32 28.9 0 0c-9.2 8.3-22.3 10.6-33.8 5.8l-85-35.4C8.4 312.8 .8 302.2 .1 290s5.5-23.7 16.1-29.8l448-256c10.7-6.1 23.9-5.5 34 1.4z"></path></svg></span><span id="waifu-tool-switch-model"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M399 384.2C376.9 345.8 335.4 320 288 320H224c-47.4 0-88.9 25.8-111 64.2c35.2 39.2 86.2 63.8 143 63.8s107.8-24.7 143-63.8zM512 256c0 141.4-114.6 256-256 256S0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM256 272c39.8 0 72-32.2 72-72s-32.2-72-72-72s-72 32.2-72 72s32.2 72 72 72z"></path></svg></span><span id="waifu-tool-switch-texture"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M320 64c0-35.3-28.7-64-64-64s-64 28.7-64 64s28.7 64 64 64s64-28.7 64-64zm-96 96c-35.3 0-64 28.7-64 64v48c0 17.7 14.3 32 32 32h1.8l11.1 99.5c1.8 16.2 15.5 28.5 31.8 28.5h38.7c16.3 0 30-12.3 31.8-28.5L318.2 304H320c17.7 0 32-14.3 32-32V224c0-35.3-28.7-64-64-64H224zM132.3 394.2c13-2.4 21.7-14.9 19.3-27.9s-14.9-21.7-27.9-19.3c-32.4 5.9-60.9 14.2-82 24.8c-10.5 5.3-20.3 11.7-27.8 19.6C6.4 399.5 0 410.5 0 424c0 21.4 15.5 36.1 29.1 45c14.7 9.6 34.3 17.3 56.4 23.4C130.2 504.7 190.4 512 256 512s125.8-7.3 170.4-19.6c22.1-6.1 41.8-13.8 56.4-23.4c13.7-8.9 29.1-23.6 29.1-45c0-13.5-6.4-24.5-14-32.6c-7.5-7.9-17.3-14.3-27.8-19.6c-21-10.6-49.5-18.9-82-24.8c-13-2.4-25.5 6.3-27.9 19.3s6.3 25.5 19.3 27.9c30.2 5.5 53.7 12.8 69 20.5c3.2 1.6 5.8 3.1 7.9 4.5c3.6 2.4 3.6 7.2 0 9.6c-8.8 5.7-23.1 11.8-43 17.3C374.3 457 318.5 464 256 464s-118.3-7-157.7-17.9c-19.9-5.5-34.2-11.6-43-17.3c-3.6-2.4-3.6-7.2 0-9.6c2.1-1.4 4.8-2.9 7.9-4.5c15.3-7.7 38.8-14.9 69-20.5z"></path></svg></span><span id="waifu-tool-photo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M220.6 121.2L271.1 96 448 96v96H333.2c-21.9-15.1-48.5-24-77.2-24s-55.2 8.9-77.2 24H64V128H192c9.9 0 19.7-2.3 28.6-6.8zM0 128V416c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H271.1c-9.9 0-19.7 2.3-28.6 6.8L192 64H160V48c0-8.8-7.2-16-16-16H80c-8.8 0-16 7.2-16 16l0 16C28.7 64 0 92.7 0 128zM344 304c0 48.6-39.4 88-88 88s-88-39.4-88-88s39.4-88 88-88s88 39.4 88 88z"></path></svg></span><span id="waifu-tool-info"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M256 512c141.4 0 256-114.6 256-256S397.4 0 256 0S0 114.6 0 256S114.6 512 256 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-144c-17.7 0-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32s-14.3 32-32 32z"></path></svg></span><span id="waifu-tool-quit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M310.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L160 210.7 54.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L114.7 256 9.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 301.3 265.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L205.3 256 310.6 150.6z"></path></svg></span></div>
        </div></body></html>